<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ÙƒØ´Ù Ø§Ù„Ø­Ø¶ÙˆØ± â€” Ø¨Ø±Ù†Ø§Ù…Ø¬ ÙŠØ³ÙŠØ± Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<style>
:root {
  --primary: #1a3a5c;
  --accent:  #1a6b4a;
  --accent2: #22a06b;
  --bg:      #f3faf6;
  --card:    #ffffff;
  --border:  #c8e6d4;
  --text:    #1a1a2e;
  --muted:   #7a7a9a;
  --green:   #16a34a;
  --red:     #dc2626;
  --yellow:  #d97706;
  --radius:  14px;
  --shadow:  0 4px 24px rgba(194,90,0,0.10);
}
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:'Cairo',sans-serif; background:var(--bg); color:var(--text); min-height:100vh; }

/* HEADER */
.page-header {
  background: linear-gradient(135deg, #1a3a5c 0%, #c25a00 100%);
  color:#fff; padding:18px 24px;
  display:flex; align-items:center; justify-content:space-between; gap:12px;
  flex-wrap:wrap;
}
.page-header h1 { font-size:1.2rem; font-weight:800; }
.page-header p  { font-size:0.78rem; opacity:0.85; margin-top:2px; }
.back-btn {
  background:rgba(255,255,255,0.15); color:#fff; border:1px solid rgba(255,255,255,0.3);
  padding:8px 16px; border-radius:20px; font-size:0.82rem; font-weight:700;
  text-decoration:none; transition:all 0.2s;
}
.back-btn:hover { background:rgba(255,255,255,0.25); }

/* TOOLBAR */
.toolbar {
  background:#fff; border-bottom:2px solid var(--border);
  padding:14px 20px; display:flex; gap:12px; align-items:center; flex-wrap:wrap;
  position:sticky; top:0; z-index:100; box-shadow:0 2px 12px rgba(0,0,0,0.06);
}
.toolbar-group { display:flex; align-items:center; gap:8px; }
.toolbar label { font-size:0.82rem; font-weight:700; color:var(--muted); white-space:nowrap; }
select, input[type="date"], input[type="text"] {
  border:1px solid var(--border); border-radius:8px;
  padding:7px 12px; font-family:'Cairo',sans-serif; font-size:0.84rem;
  color:var(--text); background:#fff; outline:none;
  transition: border-color 0.2s;
}
select:focus, input:focus { border-color:var(--accent); }
.btn {
  padding:8px 16px; border-radius:10px; border:none; cursor:pointer;
  font-family:'Cairo',sans-serif; font-size:0.82rem; font-weight:700;
  transition:all 0.2s; display:flex; align-items:center; gap:6px;
}
.btn-primary   { background:var(--accent); color:#fff; }
.btn-primary:hover { background:var(--accent2); transform:translateY(-1px); }
.btn-success   { background:#16a34a; color:#fff; }
.btn-success:hover { background:#15803d; }
.btn-outline   { background:#fff; color:var(--accent); border:1.5px solid var(--accent); }
.btn-outline:hover { background:#f0faf5; }
.btn-dark      { background:var(--primary); color:#fff; }
.btn-dark:hover { background:#0f2440; }

/* WEEK SELECTOR */
.week-info {
  background: linear-gradient(135deg, #f0faf5, #fff);
  border:1.5px solid var(--border); border-radius:var(--radius);
  padding:12px 20px; margin:16px 20px;
  display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:10px;
}
.week-info .week-label { font-size:0.9rem; font-weight:800; color:var(--accent); }
.week-info .week-dates { font-size:0.78rem; color:var(--muted); }
.week-nav { display:flex; gap:8px; }
.week-nav-btn {
  background:var(--accent); color:#fff; border:none; border-radius:8px;
  padding:6px 14px; cursor:pointer; font-size:0.82rem; font-weight:700;
  font-family:'Cairo',sans-serif; transition:all 0.2s;
}
.week-nav-btn:hover { background:var(--accent2); }

/* STATS */
.stats-row {
  display:grid; grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
  gap:12px; margin:0 20px 16px;
}
.stat-box {
  background:#fff; border:1px solid var(--border); border-radius:var(--radius);
  padding:14px 16px; text-align:center; box-shadow:var(--shadow);
}
.stat-box .stat-n { font-size:1.6rem; font-weight:900; }
.stat-box .stat-l { font-size:0.72rem; color:var(--muted); margin-top:2px; }
.stat-green .stat-n { color:var(--green); }
.stat-red   .stat-n { color:var(--red); }
.stat-yellow .stat-n{ color:var(--yellow); }
.stat-blue  .stat-n { color:var(--primary); }

/* TABLE */
.table-wrap {
  margin:0 20px 20px; border-radius:var(--radius);
  overflow:auto; box-shadow:var(--shadow);
  border:1px solid var(--border);
}
table { border-collapse:collapse; width:100%; min-width:900px; background:#fff; }
thead tr { background:linear-gradient(135deg, #1a3a5c, #1a6b4a); color:#fff; }
thead th {
  padding:12px 10px; font-size:0.78rem; font-weight:700;
  text-align:center; white-space:nowrap;
  border-left:1px solid rgba(255,255,255,0.15);
}
thead th:first-child { text-align:right; padding-right:16px; min-width:180px; }
thead th.day-col { min-width:90px; }

tbody tr { border-bottom:1px solid var(--border); transition:background 0.15s; }
tbody tr:hover { background:#f0faf5; }
tbody tr:last-child { border-bottom:none; }

.student-cell {
  padding:10px 16px 10px 10px;
  display:flex; align-items:center; gap:10px;
}
.student-num {
  background:var(--accent); color:#fff;
  width:22px; height:22px; border-radius:50%;
  font-size:0.68rem; font-weight:800;
  display:flex; align-items:center; justify-content:center; flex-shrink:0;
}
.student-name { font-size:0.82rem; font-weight:700; }
.student-absent-count {
  font-size:0.68rem; color:var(--red); font-weight:700;
  background:#fee2e2; padding:1px 7px; border-radius:20px; margin-top:1px;
}

/* STATUS BUTTONS */
.status-cell { padding:8px; text-align:center; }
.status-btn {
  width:100%; padding:6px 4px; border-radius:8px; border:none;
  cursor:pointer; font-size:0.78rem; font-weight:700;
  font-family:'Cairo',sans-serif; transition:all 0.2s;
  min-width:70px;
}
.status-present { background:#dcfce7; color:#16a34a; }
.status-absent  { background:#fee2e2; color:#dc2626; }
.status-late    { background:#fef9c3; color:#b45309; }
.status-excuse  { background:#ede9fe; color:#7c3aed; }
.status-btn:hover { transform:scale(1.05); filter:brightness(0.95); }
.status-btn.active-present { background:#16a34a; color:#fff; }
.status-btn.active-absent  { background:#dc2626; color:#fff; }
.status-btn.active-late    { background:#d97706; color:#fff; }
.status-btn.active-excuse  { background:#7c3aed; color:#fff; }

/* DROPDOWN STATUS */
.status-select {
  width:100%; padding:6px 4px; border-radius:8px;
  border:1.5px solid var(--border); font-family:'Cairo',sans-serif;
  font-size:0.78rem; font-weight:700; cursor:pointer;
  outline:none; text-align:center;
}
.status-select.val-p { background:#dcfce7; color:#16a34a; border-color:#86efac; }
.status-select.val-a { background:#fee2e2; color:#dc2626; border-color:#fca5a5; }
.status-select.val-l { background:#fef9c3; color:#b45309; border-color:#fde047; }
.status-select.val-e { background:#ede9fe; color:#7c3aed; border-color:#c4b5fd; }
.status-select.val-h { background:#e0f2fe; color:#0369a1; border-color:#7dd3fc; }
.status-select.val-s { background:#f1f5f9; color:#475569; border-color:#cbd5e1; }

.note-cell { padding:8px 6px; }
.note-input {
  width:100%; padding:5px 8px; border-radius:6px;
  border:1px solid var(--border); font-family:'Cairo',sans-serif;
  font-size:0.75rem; resize:none; min-width:80px; max-width:140px;
}
.note-input:focus { border-color:var(--accent); outline:none; }

.total-cell {
  padding:8px; text-align:center;
  font-weight:800; font-size:0.85rem;
}

/* SIGNATURE SECTION */
.sign-section {
  background:#fff; border:1.5px solid var(--border);
  border-radius:var(--radius); margin:0 20px 20px;
  padding:20px; box-shadow:var(--shadow);
}
.sign-section h3 { font-size:0.95rem; font-weight:800; color:var(--primary); margin-bottom:16px; }
.sign-grid { display:grid; grid-template-columns:1fr; gap:20px; max-width:400px; }
.sign-box-wrap { display:flex; flex-direction:column; gap:8px; }
.sign-label { font-size:0.82rem; font-weight:700; color:var(--muted); }
.sign-name-input {
  border:1px solid var(--border); border-radius:8px;
  padding:8px 12px; font-family:'Cairo',sans-serif; font-size:0.84rem; width:100%;
}
.sign-canvas-wrap {
  border:2px dashed var(--border); border-radius:10px;
  height:100px; position:relative; overflow:hidden; background:#fafafa;
  cursor:crosshair;
}
.sign-canvas-wrap canvas { width:100%; height:100%; display:block; }
.sign-canvas-wrap .sign-placeholder {
  position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
  color:var(--muted); font-size:0.8rem; pointer-events:none;
}
.sign-actions { display:flex; gap:8px; margin-top:4px; }
.btn-sm { padding:5px 12px; font-size:0.75rem; border-radius:8px; border:none; cursor:pointer; font-family:'Cairo',sans-serif; font-weight:700; transition:all 0.2s; }
.btn-sm-clear { background:#fee2e2; color:#dc2626; }
.btn-sm-clear:hover { background:#fca5a5; }

/* SAVE STATUS TOAST */
.toast {
  position:fixed; bottom:24px; right:24px; z-index:9999;
  background:var(--primary); color:#fff; padding:12px 20px;
  border-radius:12px; font-size:0.85rem; font-weight:700;
  box-shadow:0 8px 24px rgba(0,0,0,0.2);
  transform:translateY(80px); opacity:0;
  transition:all 0.3s; pointer-events:none;
}
.toast.show { transform:translateY(0); opacity:1; }

/* PDF PREVIEW */
.pdf-btn-row { display:flex; gap:10px; flex-wrap:wrap; margin:0 20px 20px; }

/* RESPONSIVE */
@media(max-width:768px) {
  .toolbar { padding:10px 12px; }
  .sign-grid { grid-template-columns:1fr; }
  .stats-row { grid-template-columns:repeat(2,1fr); }
  .week-info { margin:12px; }
  .table-wrap { margin:0 12px 16px; }
  .pdf-btn-row { margin:0 12px 16px; }
  .sign-section { margin:0 12px 16px; }
}
</style>
</head>
<body>

<!-- HEADER -->
<div class="page-header">
  <div>
    <h1>ğŸ“˜ ÙƒØ´Ù Ø­Ø¶ÙˆØ± â€” Ø¨Ø±Ù†Ø§Ù…Ø¬ ÙŠØ³ÙŠØ± Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ</h1>
    <p>Ù…Ø¯Ø±Ø³Ø© Ù…ÙƒØ© Ø§Ù„Ù…ÙƒØ±Ù…Ø© Ø§Ù„Ù…ØªÙˆØ³Ø·Ø© â€” Ù‚Ø³Ù… Ø°ÙˆÙŠ Ø§Ù„Ø¥Ø¹Ø§Ù‚Ø©</p>
  </div>
  <a href="students.html" class="back-btn">â† Ø§Ù„Ø¹ÙˆØ¯Ø©</a>
</div>

<!-- TOOLBAR -->
<div class="toolbar">
  <div class="toolbar-group">
    <label>ğŸ“… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹:</label>
    <input type="date" id="weekStart" onchange="setWeekFromDate(this.value)">
  </div>
  <div class="toolbar-group">
    <label>ğŸ“š Ø§Ù„ÙØµÙ„:</label>
    <select id="semesterSelect">
      <option value="Ø§Ù„ÙØµÙ„ Ø§Ù„Ø£ÙˆÙ„ 1447">Ø§Ù„ÙØµÙ„ Ø§Ù„Ø£ÙˆÙ„ 1447</option>
      <option value="Ø§Ù„ÙØµÙ„ Ø§Ù„Ø«Ø§Ù†ÙŠ 1447" selected>Ø§Ù„ÙØµÙ„ Ø§Ù„Ø«Ø§Ù†ÙŠ 1447</option>
    </select>
  </div>
  <div class="toolbar-group" style="margin-right:auto;">
    <button class="btn btn-success" onclick="saveAttendance()">ğŸ’¾ Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©</button>
    <button class="btn btn-dark" onclick="printAttendance()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
    <button class="btn btn-outline" onclick="markAllPresent()">âœ… ØªØ­Ø¶ÙŠØ± Ø§Ù„ÙƒÙ„</button>
  </div>
</div>

<!-- WEEK INFO -->
<div class="week-info">
  <div>
    <div class="week-label" id="weekLabel">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ</div>
    <div class="week-dates" id="weekDates">â€”</div>
  </div>
  <div class="week-nav">
    <button class="week-nav-btn" onclick="changeWeek(-1)">â†’ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
    <button class="week-nav-btn" onclick="changeWeek(1)">â† Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„ØªØ§Ù„ÙŠ</button>
  </div>
</div>

<!-- STATS -->
<div class="stats-row" id="statsRow">
  <div class="stat-box stat-green"><div class="stat-n" id="statP">0</div><div class="stat-l">âœ… Ø­Ø§Ø¶Ø±</div></div>
  <div class="stat-box stat-red">  <div class="stat-n" id="statA">0</div><div class="stat-l">âŒ ØºØ§Ø¦Ø¨</div></div>
  <div class="stat-box stat-yellow"><div class="stat-n" id="statL">0</div><div class="stat-l">â° Ù…ØªØ£Ø®Ø±</div></div>
  <div class="stat-box">            <div class="stat-n" id="statE">0</div><div class="stat-l">ğŸ“‹ Ø¨Ø¹Ø°Ø±</div></div>
  <div class="stat-box stat-blue">  <div class="stat-n" id="statPct">0%</div><div class="stat-l">Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ±</div></div>
</div>

<!-- TABLE -->
<div class="table-wrap">
  <table id="attendanceTable">
    <thead>
      <tr>
        <th>#</th>
        <th style="text-align:right">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th>
        <th class="day-col">Ø§Ù„Ø£Ø­Ø¯</th>
        <th class="day-col">Ø§Ù„Ø§Ø«Ù†ÙŠÙ†</th>
        <th class="day-col">Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</th>
        <th class="day-col">Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</th>
        <th class="day-col">Ø§Ù„Ø®Ù…ÙŠØ³</th>
        <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
        <th>ØºÙŠØ§Ø¨</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>
</div>

<!-- SIGNATURE SECTION -->
<div class="sign-section">
  <h3>âœï¸ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹Ø§Øª</h3>
  <div class="sign-grid">
    <div class="sign-box-wrap">
      <div class="sign-label">ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø¹Ù„Ù…</div>
      <input class="sign-name-input" id="teacherName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…">
      <div class="sign-canvas-wrap" id="teacherWrap">
        <canvas id="teacherCanvas"></canvas>
        <div class="sign-placeholder" id="tchPlaceholder">âœï¸ ÙˆÙ‚Ù‘Ø¹ Ù‡Ù†Ø§</div>
      </div>
      <div class="sign-actions">
        <button class="btn-sm btn-sm-clear" onclick="clearSign('teacherCanvas','tchPlaceholder')">Ù…Ø³Ø­ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹</button>
      </div>
    </div>
  </div>
</div>

<!-- BUTTONS -->
<div class="pdf-btn-row">
  <button class="btn btn-success" onclick="saveAttendance()">ğŸ’¾ Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©</button>
  <button class="btn btn-dark" onclick="printAttendance()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© / ØªØµØ¯ÙŠØ± PDF</button>
</div>

<div class="toast" id="toast"></div>

<script>
// ===== CONFIG =====
const PROGRAM   = 'yaseer';
const SB_URL    = 'https://pyrxwqgapwjwhiskowhk.supabase.co';
const SB_KEY    = 'sb_publishable_bfe-B4f-Rag1SR0-PoIb9w_nMfA1Ere';
const DAYS      = ['Ø§Ù„Ø£Ø­Ø¯','Ø§Ù„Ø§Ø«Ù†ÙŠÙ†','Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','Ø§Ù„Ø®Ù…ÙŠØ³'];
const STATUS_OPTS = [
  {val:'p', label:'âœ… Ø­Ø§Ø¶Ø±',         cls:'val-p'},
  {val:'a', label:'âŒ ØºÙŠØ§Ø¨',         cls:'val-a'},
  {val:'l', label:'â° Ù…ØªØ£Ø®Ø±',        cls:'val-l'},
  {val:'e', label:'ğŸ“‹ Ø¨Ø¹Ø°Ø±',         cls:'val-e'},
  {val:'h', label:'ğŸ–ï¸ Ø¥Ø¬Ø§Ø²Ø©',       cls:'val-h'},
  {val:'s', label:'ğŸš« ØªØ¹Ù„ÙŠÙ‚ Ø¯Ø±Ø§Ø³Ø©', cls:'val-s'},
];

const STUDENTS = [
  {pin:'5271', name:'Ù…Ø­Ù…Ø¯ Ø¹Ù„ÙŠ ØºØ±Ù… Ø§Ù„Ù„Ù‡ Ø§Ù„Ø´Ù…Ø±Ø§Ù†ÙŠ'},
  {pin:'3955', name:'Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ù‚Ø§Ø¦Ø¯ Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø§Ù„Ø´Ù‡Ø±Ø§Ù†ÙŠ'},
  {pin:'3154', name:'Ø¨Ø³Ø§Ù… Ø®Ø§Ù„Ø¯ Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø­Ù…Ù† Ø§Ù„Ù…Ø§Ù„ÙƒÙŠ'},
  {pin:'3493', name:'ÙˆØ³Ø§Ù… Ø¹ÙˆØ¶ Ø¨Ù† Ø´ÙŠÙ†Ø§Ù† Ø§Ù„Ø³Ù‡ÙŠÙ…ÙŠ'},
  {pin:'9055', name:'Ø­Ø³Ù† ØµØ§Ù„Ø­ Ø­Ø³Ù† Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ'},
  {pin:'0962', name:'Ø¥ÙŠØ§Ø¯ Ø®Ù„ÙŠÙ„ Ø·Ø§Ù‡Ø± Ù…ØµØ·ÙÙ‰'},
  {pin:'4073', name:'Ù…Ø­Ù…Ø¯ Ø¹Ù…Ø± Ù…Ø­Ù…Ø¯ Ø¨Ù„Ù‚Ø§Ø³Ù… Ø§Ù„Ø­Ø±Ø§Ø²ÙŠ'},
  {pin:'0788', name:'Ø£Ù…Ø¬Ø¯ Ù…Ø±Ø²ÙˆÙ‚ Ø¹Ù„ÙŠ Ø§Ù„Ù…Ø­ÙˆØ±ÙŠ'},
  {pin:'8726', name:'Ù…Ø±Ø§Ø¯ Ø¹Ù„ÙŠ Ø¸Ù„Ù…ÙŠØ³ Ø§Ù„Ù…Ù†ØªØ´Ø±ÙŠ'},
  {pin:'2261', name:'ÙÙŠØµÙ„ Ø­Ø§ØªÙ… Ø­Ø§Ù…Ø¯ Ø§Ù„ØºØ§Ù…Ø¯ÙŠ'},
  {pin:'9446', name:'Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø­Ù…Ù† ØªÙˆÙÙŠÙ‚ Ø¹Ù„ÙˆØ§Ù† Ù…Ù‚Ø±ÙŠ'},
  {pin:'7895', name:'Ù…Ø­Ù…Ø¯ ÙØ§Ø±Ø³ ØµØ§Ù„Ø­ Ø§Ù„ØºØ§Ù…Ø¯ÙŠ'},
  {pin:'5362', name:'ÙˆØ³ÙŠÙ… Ø£Ø­Ù…Ø¯ Ø¹Ù„ÙŠ Ø§Ù„Ø±Ø²Ù‚ÙŠ'},
  {pin:'2571', name:'ÙØ§Ø±Ø³ Ù…Ø­Ù…Ø¯ Ù…Ø§Ù†Ø¹ Ø§Ù„Ù‚Ø­Ø·Ø§Ù†ÙŠ'},
  {pin:'3590', name:'Ø¹Ø¨Ø¯Ø§Ù„Ù…Ø¬ÙŠØ¯ Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø­Ø§Ù…Ø¯ Ø§Ù„Ù‡Ù„Ø§Ù„ÙŠ'},
  {pin:'8151', name:'Ù…Ø³ÙØ± Ø­Ø³Ù† Ø³Ø¹Ø¯ Ø§Ù„Ù‚Ø­Ø·Ø§Ù†ÙŠ'},
  {pin:'8061', name:'Ù‡ØªØ§Ù† Ø¹Ø¨ÙŠØ¯Ø§Ù„Ù„Ù‡ Ø¬Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ù…Ø§Ø¯ÙŠ'},
  {pin:'5455', name:'Ø·Ù„Ø§Ù„ Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø­Ù…Ù† Ø§Ù„Ø¹ØµÙ…Ø§Ù†ÙŠ'},
  {pin:'6812', name:'Ù„ÙˆÙ‰ Ø£Ø­Ù…Ø¯ Ø¹Ù„ÙŠ Ø§Ù„Ø±Ø²Ù‚ÙŠ'},
  {pin:'5237', name:'Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ù…Ø§Ø¬Ø¯ Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ'},
];

// ===== STATE =====
let currentWeekStart = getThisSunday();
let attendanceData   = {}; // {weekKey: {pin: {day0..4: 'p'|'a'|'l'|'e', note:''}}}

// ===== WEEK UTILS =====
function getThisSunday() {
  const d = new Date();
  const day = d.getDay(); // 0=Sun
  d.setDate(d.getDate() - day);
  d.setHours(0,0,0,0);
  return d;
}
function weekKey(d) {
  return d.toISOString().slice(0,10);
}
function formatDate(d) {
  return d.toLocaleDateString('ar-SA-u-nu-latn', {day:'numeric',month:'numeric'});
}
function setWeekFromDate(val) {
  const d = new Date(val);
  const day = d.getDay();
  d.setDate(d.getDate() - day);
  d.setHours(0,0,0,0);
  currentWeekStart = d;
  renderAll();
}
function changeWeek(dir) {
  currentWeekStart.setDate(currentWeekStart.getDate() + dir * 7);
  renderAll();
}
function getWeekDays() {
  return DAYS.map((name, i) => {
    const d = new Date(currentWeekStart);
    d.setDate(d.getDate() + i);
    return {name, date: d, dateStr: formatDate(d)};
  });
}

// ===== RENDER =====
function renderAll() {
  updateWeekHeader();
  renderTable();
  updateStats();
  // ØªØ­Ø¯ÙŠØ« input Ø§Ù„ØªØ§Ø±ÙŠØ®
  document.getElementById('weekStart').value = weekKey(currentWeekStart);
}

function updateWeekHeader() {
  const days = getWeekDays();
  const wk   = Math.ceil((currentWeekStart - new Date(currentWeekStart.getFullYear(), 0, 1)) / 604800000);
  document.getElementById('weekLabel').textContent = `Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ${wk}`;
  document.getElementById('weekDates').textContent =
    `${days[0].dateStr} â€” ${days[4].dateStr}`;
}

function renderTable() {
  const wk   = weekKey(currentWeekStart);
  const days = getWeekDays();
  const tbody = document.getElementById('tableBody');

  // ØªØ­Ø¯ÙŠØ« Ø±Ø£Ø³ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®
  const ths = document.querySelectorAll('#attendanceTable thead th.day-col');
  ths.forEach((th, i) => {
    th.innerHTML = `${days[i].name}<br><small style="font-weight:400;opacity:0.8;">${days[i].dateStr}</small>`;
  });

  tbody.innerHTML = STUDENTS.map((stu, idx) => {
    const rec  = (attendanceData[wk]?.[stu.pin]) || {};
    const absCount = countAbsences(stu.pin);

    const dayCells = DAYS.map((_, di) => {
      const val = rec[`d${di}`] || 'p';
      const opts = STATUS_OPTS.map(o =>
        `<option value="${o.val}" ${val===o.val?'selected':''}>${o.label}</option>`
      ).join('');
      return `<td class="status-cell">
        <select class="status-select val-${val}"
          data-pin="${stu.pin}" data-day="${di}"
          onchange="onStatusChange(this)">
          ${opts}
        </select>
      </td>`;
    }).join('');

    return `<tr>
      <td style="text-align:center;padding:8px;font-size:0.78rem;color:var(--muted);">${idx+1}</td>
      <td>
        <div class="student-cell">
          <div class="student-num">${idx+1}</div>
          <div>
            <div class="student-name">${stu.name}</div>
            ${absCount > 0 ? `<div class="student-absent-count">ØºÙŠØ§Ø¨: ${absCount} ÙŠÙˆÙ…</div>` : ''}
          </div>
        </div>
      </td>
      ${dayCells}
      <td class="note-cell">
        <input class="note-input" type="text" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø©..."
          value="${rec.note||''}" data-pin="${stu.pin}"
          onchange="onNoteChange(this)" maxlength="60">
      </td>
      <td class="total-cell" id="abs-${stu.pin}" style="color:var(--red);">
        ${getDayAbsences(stu.pin, wk)}
      </td>
    </tr>`;
  }).join('');
}

function onStatusChange(sel) {
  const pin = sel.dataset.pin;
  const day = sel.dataset.day;
  const val = sel.value;
  const wk  = weekKey(currentWeekStart);

  if (!attendanceData[wk]) attendanceData[wk] = {};
  if (!attendanceData[wk][pin]) attendanceData[wk][pin] = {};
  attendanceData[wk][pin][`d${day}`] = val;

  // ØªØ­Ø¯ÙŠØ« Ù„ÙˆÙ† Ø§Ù„Ù€ select
  sel.className = `status-select val-${val}`;

  updateStats();
  // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØºÙŠØ§Ø¨ Ù„Ù„Ø·Ø§Ù„Ø¨
  document.getElementById(`abs-${pin}`).textContent = getDayAbsences(pin, wk);

  // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØºÙŠØ§Ø¨ Ø§Ù„ÙƒÙ„ÙŠ
  const row = sel.closest('tr');
  const absDiv = row.querySelector('.student-absent-count');
  const total = countAbsences(pin);
  if (total > 0) {
    if (absDiv) absDiv.textContent = `ØºÙŠØ§Ø¨: ${total} ÙŠÙˆÙ…`;
    else row.querySelector('.student-name').insertAdjacentHTML('afterend',
      `<div class="student-absent-count">ØºÙŠØ§Ø¨: ${total} ÙŠÙˆÙ…</div>`);
  } else {
    absDiv?.remove();
  }
}

function onNoteChange(inp) {
  const pin = inp.dataset.pin;
  const wk  = weekKey(currentWeekStart);
  if (!attendanceData[wk]) attendanceData[wk] = {};
  if (!attendanceData[wk][pin]) attendanceData[wk][pin] = {};
  attendanceData[wk][pin].note = inp.value;
}

function getDayAbsences(pin, wk) {
  const rec = attendanceData[wk]?.[pin] || {};
  return DAYS.filter((_, i) => rec[`d${i}`] === 'a').length;
}

function countAbsences(pin) {
  let total = 0;
  for (const wk of Object.keys(attendanceData)) {
    total += getDayAbsences(pin, wk);
  }
  return total;
}

function updateStats() {
  const wk = weekKey(currentWeekStart);
  let p=0, a=0, l=0, e=0, total=0;
  STUDENTS.forEach(stu => {
    const rec = attendanceData[wk]?.[stu.pin] || {};
    DAYS.forEach((_, di) => {
      const v = rec[`d${di}`] || 'p';
      total++;
      if (v==='p') p++;
      else if (v==='a') a++;
      else if (v==='l') l++;
      else if (v==='e') e++;
    });
  });
  document.getElementById('statP').textContent = p;
  document.getElementById('statA').textContent = a;
  document.getElementById('statL').textContent = l;
  document.getElementById('statE').textContent = e;
  document.getElementById('statPct').textContent = total ? Math.round((p+l)/total*100)+'%' : '0%';
}

function markAllPresent() {
  const wk = weekKey(currentWeekStart);
  if (!attendanceData[wk]) attendanceData[wk] = {};
  STUDENTS.forEach(stu => {
    if (!attendanceData[wk][stu.pin]) attendanceData[wk][stu.pin] = {};
    DAYS.forEach((_, di) => { attendanceData[wk][stu.pin][`d${di}`] = 'p'; });
  });
  renderTable();
  updateStats();
  showToast('âœ… ØªÙ… ØªØ­Ø¶ÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨');
}

// ===== SIGNATURE =====
const canvases = {};

function initCanvas(id, wrapperId, placeholderId) {
  const wrap = document.getElementById(wrapperId);
  const canvas = document.getElementById(id);
  const ph = document.getElementById(placeholderId);
  canvas.width  = wrap.offsetWidth  || 400;
  canvas.height = wrap.offsetHeight || 100;
  const ctx = canvas.getContext('2d');
  ctx.strokeStyle = '#1a3a5c';
  ctx.lineWidth   = 2.5;
  ctx.lineCap     = 'round';
  canvases[id]    = {ctx, drawing:false, hasContent:false};

  function getPos(e) {
    const r = canvas.getBoundingClientRect();
    const src = e.touches?.[0] || e;
    return {x:(src.clientX-r.left)*(canvas.width/r.width), y:(src.clientY-r.top)*(canvas.height/r.height)};
  }
  function start(e) { e.preventDefault(); const p=getPos(e); canvases[id].drawing=true; ctx.beginPath(); ctx.moveTo(p.x,p.y); ph.style.display='none'; }
  function move(e)  { e.preventDefault(); if(!canvases[id].drawing) return; const p=getPos(e); ctx.lineTo(p.x,p.y); ctx.stroke(); canvases[id].hasContent=true; }
  function end()    { canvases[id].drawing=false; }

  canvas.addEventListener('mousedown', start);
  canvas.addEventListener('mousemove', move);
  canvas.addEventListener('mouseup',   end);
  canvas.addEventListener('touchstart', start, {passive:false});
  canvas.addEventListener('touchmove',  move,  {passive:false});
  canvas.addEventListener('touchend',   end);
}

function clearSign(id, phId) {
  const {ctx} = canvases[id];
  const canvas = document.getElementById(id);
  ctx.clearRect(0,0,canvas.width,canvas.height);
  canvases[id].hasContent = false;
  document.getElementById(phId).style.display='flex';
}

// ===== SAVE / LOAD =====
async function saveAttendance() {
  showToast('â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...');
  const wk   = weekKey(currentWeekStart);
  const sem  = document.getElementById('semesterSelect').value;

  const supervisorSign = null;
  const teacherSign = canvases['teacherCanvas']?.hasContent
    ? document.getElementById('teacherCanvas').toDataURL() : null;

  const payload = {
    week:       wk,
    semester:   sem,
    program:    PROGRAM,
    data:       attendanceData[wk] || {},
    teacher:    document.getElementById('teacherName').value,
    teacherSign,
    savedAt:    new Date().toISOString(),
  };

  const blob = new Blob([JSON.stringify(payload)], {type:'application/json'});
  try {
    const res = await fetch(
      `${SB_URL}/storage/v1/object/reports/${PROGRAM}/attendance/attendance-${wk}.json`,
      {
        method:'POST',
        headers:{'apikey':SB_KEY,'Authorization':'Bearer '+SB_KEY,'Content-Type':'application/json','x-upsert':'true'},
        body: blob
      }
    );
    if (res.ok) showToast('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©');
    else        showToast('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸: ' + await res.text());
  } catch(e) {
    showToast('âŒ ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø§ØªØµØ§Ù„');
  }
}

async function loadAttendance(wk) {
  try {
    const res = await fetch(
      `${SB_URL}/storage/v1/object/public/reports/${PROGRAM}/attendance/attendance-${wk}.json`
    );
    if (!res.ok) return;
    const payload = await res.json();
    if (payload.data) {
      attendanceData[wk] = payload.data;
      // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…ÙˆÙ‚Ù‘Ø¹ÙŠÙ†
      // supervisor removed
      if (payload.teacher)    document.getElementById('teacherName').value    = payload.teacher;
    }
    renderTable();
    updateStats();
  } catch(e) {}
}

// ===== PRINT =====
function printAttendance() {
  const wk   = weekKey(currentWeekStart);
  const days = getWeekDays();
  const sem  = document.getElementById('semesterSelect').value;
  const supName = '';
  const tchName = document.getElementById('teacherName').value;
  const tchSign = canvases['teacherCanvas']?.hasContent    ? document.getElementById('teacherCanvas').toDataURL()    : null;

  const statusLabel = {p:'Ø­Ø§Ø¶Ø±', a:'ØºØ§Ø¦Ø¨', l:'Ù…ØªØ£Ø®Ø±', e:'Ø¨Ø¹Ø°Ø±'};
  const statusColor = {p:'#dcfce7', a:'#fee2e2', l:'#fef9c3', e:'#ede9fe'};
  const statusTxt   = {p:'#16a34a', a:'#dc2626', l:'#b45309', e:'#7c3aed'};

  const rows = STUDENTS.map((stu, idx) => {
    const rec = attendanceData[wk]?.[stu.pin] || {};
    const cells = DAYS.map((_, di) => {
      const v = rec[`d${di}`] || 'p';
      return `<td style="text-align:center;background:${statusColor[v]};color:${statusTxt[v]};font-weight:700;font-size:0.75rem;padding:6px 4px;">${statusLabel[v]}</td>`;
    }).join('');
    const absCount = getDayAbsences(stu.pin, wk);
    return `<tr style="border-bottom:1px solid #e0d8c8;">
      <td style="text-align:center;padding:6px;font-size:0.75rem;color:#888;">${idx+1}</td>
      <td style="padding:6px 12px;font-size:0.82rem;font-weight:700;">${stu.name}</td>
      ${cells}
      <td style="padding:6px 10px;font-size:0.75rem;color:#888;">${rec.note||''}</td>
      <td style="text-align:center;padding:6px;font-size:0.8rem;font-weight:800;color:#dc2626;">${absCount||''}</td>
    </tr>`;
  }).join('');

  const dayHeaders = days.map(d =>
    `<th style="padding:10px 6px;text-align:center;min-width:70px;">${d.name}<br><small>${d.dateStr}</small></th>`
  ).join('');

  const win = window.open('','_blank');
  win.document.write(`<!DOCTYPE html><html lang="ar" dir="rtl"><head>
    <meta charset="UTF-8">
    <title>ÙƒØ´Ù Ø­Ø¶ÙˆØ± â€” ÙŠØ³ÙŠØ± â€” ${wk}</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
      body{font-family:'Cairo',sans-serif;padding:24px;color:#1a1a2e;direction:rtl;}
      h2{color:#1a3a5c;font-size:1.1rem;margin-bottom:4px;}
      .meta{font-size:0.78rem;color:#888;margin-bottom:16px;}
      table{width:100%;border-collapse:collapse;font-size:0.82rem;}
      thead{background:linear-gradient(135deg,#1a3a5c,#c25a00);color:#fff;}
      thead th{padding:10px 6px;font-weight:700;}
      .sign-row{display:flex;gap:40px;margin-top:30px;}
      .sign-box{flex:1;border:1px solid #e0d8c8;border-radius:10px;padding:14px;text-align:center;}
      .sign-box label{font-size:0.75rem;color:#888;display:block;margin-bottom:8px;}
      .sign-box .name{font-size:0.88rem;font-weight:800;margin-bottom:8px;}
      .sign-img{max-height:70px;border:1px dashed #ccc;border-radius:6px;}
      @media print{body{padding:10px;}}
    </style>
  </head><body>
    <h2>ğŸ“˜ ÙƒØ´Ù Ø­Ø¶ÙˆØ± â€” Ø¨Ø±Ù†Ø§Ù…Ø¬ ÙŠØ³ÙŠØ± Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ</h2>
    <div class="meta">
      Ù…Ø¯Ø±Ø³Ø© Ù…ÙƒØ© Ø§Ù„Ù…ÙƒØ±Ù…Ø© Ø§Ù„Ù…ØªÙˆØ³Ø·Ø© | ${sem} | Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹: ${days[0].dateStr} â€” ${days[4].dateStr}
    </div>
    <table>
      <thead><tr>
        <th style="padding:10px 6px;">#</th>
        <th style="text-align:right;padding:10px 12px;min-width:160px;">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th>
        ${dayHeaders}
        <th style="padding:10px 6px;">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
        <th style="padding:10px 6px;">ØºÙŠØ§Ø¨</th>
      </tr></thead>
      <tbody>${rows}</tbody>
    </table>
    <div class="sign-row">
      <div class="sign-box">
        <label>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø¹Ù„Ù…</label>
        <div class="name">${tchName||'â€”â€”'}</div>
        ${tchSign ? `<img src="${tchSign}" class="sign-img">` : '<div style="height:50px;border:1px dashed #ccc;border-radius:6px;"></div>'}
      </div>
    </div>
    <script>window.onload=()=>{setTimeout(()=>window.print(),400);}<\/script>
  </body></html>`);
  win.document.close();
}

// ===== TOAST =====
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}

// ===== INIT =====
window.addEventListener('load', () => {
  initCanvas('teacherCanvas','teacherWrap','tchPlaceholder');
  renderAll();
  // Ø­Ù…Ù‘Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©
  loadAttendance(weekKey(currentWeekStart));
});
window.addEventListener('resize', () => {
  initCanvas('teacherCanvas','teacherWrap','tchPlaceholder');
});
</script>
</body>
</html>
