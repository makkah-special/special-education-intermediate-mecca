<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø¨ÙˆØ§Ø¨Ø© Ø·Ù„Ø§Ø¨ Ø§Ù„Ø¯Ù…Ø¬ Ø§Ù„ÙÙƒØ±ÙŠ | Ù…Ø¯Ø±Ø³Ø© Ù…ÙƒØ© Ø§Ù„Ù…ÙƒØ±Ù…Ø© Ø§Ù„Ù…ØªÙˆØ³Ø·Ø©</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800;900&family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --primary: #1a3a5c;
    --accent: #e07020;
    --accent-light: #f59040;
    --purple: #6d28d9;
    --purple-light: #7c3aed;
    --green: #c25a00;
    --green-light: #e07020;
    --bg: #f5f2eb;
    --card: #ffffff;
    --border: #e0d8c8;
    --text: #1a1a2e;
    --muted: #5a6478;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Cairo', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
  }

  /* ===== HEADER ===== */
  header {
    background: linear-gradient(135deg, #1a3a5c 0%, #0f2440 60%, #1a4a6c 100%);
    padding: 16px 36px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 3px solid var(--accent);
  }

  .header-left { display: flex; align-items: center; gap: 14px; }

  .header-icon {
    width: 46px; height: 46px;
    border-radius: 12px;
    background: rgba(200,151,58,0.18);
    border: 1px solid rgba(200,151,58,0.35);
    display: flex; align-items: center; justify-content: center;
    font-size: 1.4rem;
  }

  .header-title { color: #fff; font-family: 'Tajawal', sans-serif; font-size: 1.1rem; font-weight: 900; }
  .header-sub { color: rgba(255,255,255,0.55); font-size: 0.76rem; margin-top: 2px; }

  .back-btn {
    background: rgba(255,255,255,0.08);
    border: 1px solid rgba(255,255,255,0.18);
    color: rgba(255,255,255,0.8);
    padding: 8px 18px;
    border-radius: 8px;
    text-decoration: none;
    font-size: 0.82rem;
    font-weight: 600;
    transition: all 0.2s;
  }
  .back-btn:hover { background: rgba(255,255,255,0.15); }

  /* ===== LOGIN SCREEN ===== */
  #login-screen {
    min-height: calc(100vh - 76px);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 40px 20px;
  }

  .login-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 24px;
    padding: 48px 40px;
    max-width: 420px;
    width: 100%;
    box-shadow: 0 24px 64px rgba(0,0,0,0.1);
    text-align: center;
  }

  .login-badge {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    background: #ede9fe;
    border: 1px solid #c4b5fd;
    color: var(--purple);
    padding: 6px 18px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 700;
    margin-bottom: 20px;
  }

  .login-icon-big {
    width: 80px; height: 80px;
    border-radius: 20px;
    background: linear-gradient(135deg, #ede9fe, #ddd6fe);
    margin: 0 auto 22px;
    display: flex; align-items: center; justify-content: center;
    font-size: 2.6rem;
    box-shadow: 0 8px 24px rgba(109,40,217,0.2);
  }

  .login-card h2 {
    font-family: 'Tajawal', sans-serif;
    font-size: 1.5rem;
    font-weight: 900;
    color: var(--primary);
    margin-bottom: 8px;
  }

  .login-card .login-desc {
    color: var(--muted);
    font-size: 0.86rem;
    line-height: 1.7;
    margin-bottom: 30px;
  }

  .input-label {
    text-align: right;
    font-size: 0.83rem;
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .pin-input {
    width: 100%;
    padding: 15px 20px;
    border: 2px solid var(--border);
    border-radius: 12px;
    font-family: 'Cairo', sans-serif;
    font-size: 1.3rem;
    font-weight: 700;
    text-align: center;
    letter-spacing: 8px;
    color: var(--primary);
    outline: none;
    transition: all 0.25s;
    background: #fafafa;
    margin-bottom: 12px;
  }

  .pin-input:focus {
    border-color: var(--purple-light);
    background: #fff;
    box-shadow: 0 0 0 4px rgba(124,58,237,0.1);
  }

  .pin-input.error {
    border-color: #ef4444;
    background: #fff5f5;
    animation: shake 0.4s ease;
  }

  @keyframes shake {
    0%,100% { transform: translateX(0); }
    20% { transform: translateX(-10px); }
    60% { transform: translateX(10px); }
    80% { transform: translateX(-5px); }
  }

  .error-msg {
    display: none;
    color: #dc2626;
    font-size: 0.82rem;
    font-weight: 700;
    margin-bottom: 12px;
    background: #fee2e2;
    border-radius: 8px;
    padding: 8px 14px;
  }
  .error-msg.show { display: block; }

  .login-btn {
    width: 100%;
    padding: 14px;
    background: linear-gradient(135deg, var(--purple), var(--purple-light));
    color: #fff;
    border: none;
    border-radius: 12px;
    font-family: 'Cairo', sans-serif;
    font-size: 1rem;
    font-weight: 800;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 6px 20px rgba(109,40,217,0.3);
    letter-spacing: 0.5px;
  }
  .login-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 28px rgba(109,40,217,0.45); }
  .login-btn:active { transform: translateY(0); }

  .hint-box {
    margin-top: 22px;
    background: #fffbf0;
    border: 1px solid #f0d898;
    border-right: 3px solid var(--accent);
    border-radius: 10px;
    padding: 13px 16px;
    font-size: 0.79rem;
    color: #7a5800;
    text-align: right;
    line-height: 1.7;
  }

  /* ===== PORTAL ===== */
  #student-portal { display: none; }

  .portal-banner {
    background: linear-gradient(135deg, var(--green) 0%, #0d4a30 100%);
    padding: 26px 36px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 14px;
    border-bottom: 3px solid var(--accent);
  }

  .student-identity { color: #fff; display:flex; align-items:center; gap:16px; }
  .student-photo-wrap { position:relative; flex-shrink:0; }
  .student-photo { width:70px; height:70px; border-radius:50%; object-fit:cover; border:3px solid rgba(240,184,74,0.7); background:rgba(255,255,255,0.1); display:flex; align-items:center; justify-content:center; font-size:2rem; cursor:pointer; transition:all 0.2s; }
  .student-photo:hover { border-color:#f59040; transform:scale(1.05); }
  .student-photo img { width:100%; height:100%; border-radius:50%; object-fit:cover; }
  .photo-change-btn { position:absolute; bottom:0; left:0; background:#f59040; color:#7a2800; border:none; border-radius:50%; width:22px; height:22px; font-size:0.65rem; cursor:pointer; display:flex; align-items:center; justify-content:center; font-weight:900; box-shadow:0 2px 6px rgba(0,0,0,0.3); }
  .photo-input { display:none; }

  .student-name-display {
    font-family: 'Tajawal', sans-serif;
    font-size: 1.4rem;
    font-weight: 900;
    margin-bottom: 4px;
  }

  .student-meta-display {
    opacity: 0.7;
    font-size: 0.82rem;
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
  }

  .meta-chip {
    background: rgba(255,255,255,0.12);
    border: 1px solid rgba(255,255,255,0.2);
    padding: 3px 12px;
    border-radius: 12px;
    font-size: 0.76rem;
  }

  .logout-btn {
    background: rgba(255,255,255,0.1);
    border: 1px solid rgba(255,255,255,0.2);
    color: rgba(255,255,255,0.85);
    padding: 9px 20px;
    border-radius: 9px;
    cursor: pointer;
    font-family: 'Cairo', sans-serif;
    font-size: 0.84rem;
    font-weight: 700;
    transition: all 0.2s;
  }
  .logout-btn:hover { background: rgba(255,255,255,0.2); }

  .portal-body {
    max-width: 960px;
    margin: 0 auto;
    padding: 28px 36px 60px;
  }

  /* TABS */
  .tabs {
    display: flex;
    gap: 4px;
    background: #fff;
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 6px;
    margin-bottom: 26px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.04);
  }

  .tab-btn {
    flex: 1;
    padding: 10px 8px;
    border: none;
    background: transparent;
    border-radius: 9px;
    font-family: 'Cairo', sans-serif;
    font-size: 0.84rem;
    font-weight: 700;
    color: var(--muted);
    cursor: pointer;
    transition: all 0.22s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
  }

  .tab-btn.active {
    background: linear-gradient(135deg, var(--green), var(--green-light));
    color: #fff;
    box-shadow: 0 3px 12px rgba(26,107,74,0.35);
  }

  .tab-pane { display: none; animation: fadeIn 0.3s ease; }
  .tab-pane.active { display: block; }

  @keyframes fadeIn { from { opacity:0; transform:translateY(8px); } to { opacity:1; transform:translateY(0); } }

  /* CARD */
  .s-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 16px;
    overflow: hidden;
    margin-bottom: 18px;
    box-shadow: 0 2px 14px rgba(0,0,0,0.04);
  }

  .s-card-head {
    padding: 14px 22px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 9px;
    font-weight: 800;
    font-size: 0.92rem;
    color: var(--primary);
    background: linear-gradient(135deg, #f8fffe, #f0faf5);
  }

  /* INFO TABLE */
  .info-tbl { width: 100%; border-collapse: collapse; }
  .info-tbl tr { border-bottom: 1px solid var(--border); }
  .info-tbl tr:last-child { border-bottom: none; }
  .info-tbl th {
    padding: 12px 22px;
    text-align: right;
    font-size: 0.8rem;
    font-weight: 700;
    color: var(--muted);
    background: #f9f9f9;
    width: 30%;
  }
  .info-tbl td {
    padding: 12px 22px;
    font-size: 0.88rem;
    font-weight: 600;
    color: var(--text);
  }

  .tag {
    display: inline-block;
    padding: 3px 12px;
    border-radius: 12px;
    font-size: 0.76rem;
    font-weight: 700;
  }
  .tag-green { background: #d1fae5; color: #065f46; }
  .btn-download-report {
    display: inline-flex; align-items: center; gap: 4px;
    background: linear-gradient(135deg, #1a3a5c, #2563a8);
    color: #fff; padding: 5px 12px; border-radius: 8px;
    font-size: 0.75rem; font-weight: 700; text-decoration: none;
    white-space: nowrap; transition: all 0.2s;
    box-shadow: 0 2px 6px rgba(26,58,92,0.2);
  }
  .btn-download-report:hover { transform: translateY(-1px); box-shadow: 0 4px 10px rgba(26,58,92,0.3); }
  .tag-blue  { background: #dbeafe; color: #1e40af; }
  .tag-orange { background: #fff3e0; color: #c25a00; }
  .tag-blue { background: #dbeafe; color: #1e40af; }
  .tag-yellow { background: #fef3c7; color: #92400e; }
  .tag-purple { background: #ede9fe; color: #5b21b6; }
  .tag-gray { background: #f3f4f6; color: #4b5563; }

  /* PLAN GRID */
  .plan-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 14px;
    padding: 18px;
  }

  .plan-box {
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 16px;
    background: #fafcff;
    transition: all 0.2s;
  }
  .plan-box:hover { border-color: var(--green-light); transform: translateY(-2px); }

  .plan-box-head {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 10px;
  }

  .plan-dot {
    width: 9px; height: 9px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .plan-box h4 { font-size: 0.86rem; font-weight: 800; color: var(--primary); }
  .plan-box p { font-size: 0.8rem; color: var(--muted); line-height: 1.7; }

  /* REPORTS */
  .report-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 22px;
    border-bottom: 1px solid var(--border);
    transition: background 0.15s;
    gap: 14px;
  }
  .report-row:last-child { border-bottom: none; }
  .report-row:hover { background: #f8fffe; }

  .report-left { display: flex; align-items: center; gap: 14px; }

  .report-icon {
    width: 42px; height: 42px;
    border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    font-size: 1.2rem;
    flex-shrink: 0;
  }

  .report-name { font-size: 0.88rem; font-weight: 700; color: var(--primary); }
  .report-date { font-size: 0.75rem; color: var(--muted); margin-top: 2px; }

  /* FOLLOW-UP TABLE */
  .fu-table { width: 100%; border-collapse: collapse; font-size: 0.83rem; }
  .fu-table th {
    background: linear-gradient(135deg, var(--green), var(--green-light));
    color: #fff;
    padding: 11px 14px;
    text-align: center;
    font-weight: 700;
  }
  .fu-table td {
    padding: 10px 14px;
    text-align: center;
    border-bottom: 1px solid var(--border);
    color: var(--text);
    font-weight: 600;
  }
  .fu-table tr:last-child td { border-bottom: none; }
  .fu-table tr:hover td { background: #f0faf5; }

  .circle {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 28px; height: 28px;
    border-radius: 50%;
    font-size: 0.85rem;
  }
  .c-done { background: #d1fae5; color: #065f46; }
  .c-part { background: #fef3c7; color: #92400e; }
  .c-no   { background: #fee2e2; color: #991b1b; }

  /* PDF VIEWER */
  .pdf-section {
    margin-bottom: 24px;
  }

  .pdf-section-title {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 0.95rem;
    font-weight: 800;
    color: var(--primary);
    margin-bottom: 12px;
    padding-bottom: 10px;
    border-bottom: 2px solid var(--border);
  }

  .pdf-level-badge {
    background: var(--accent);
    color: #fff;
    padding: 3px 12px;
    border-radius: 12px;
    font-size: 0.76rem;
    font-weight: 700;
  }

  .pdf-frame-wrap {
    border: 1px solid var(--border);
    border-radius: 12px;
    overflow: hidden;
    background: #f5f5f5;
    position: relative;
  }

  .pdf-frame-wrap iframe {
    width: 100%;
    height: 500px;
    border: none;
    display: block;
  }

  .pdf-actions {
    display: flex;
    gap: 10px;
    margin-top: 10px;
    flex-wrap: wrap;
  }

  .btn-pdf {
    display: inline-flex;
    align-items: center;
    gap: 7px;
    padding: 9px 18px;
    border-radius: 9px;
    font-family: 'Cairo', sans-serif;
    font-size: 0.84rem;
    font-weight: 700;
    text-decoration: none;
    transition: all 0.2s;
    border: none;
    cursor: pointer;
  }

  .btn-pdf-primary {
    background: linear-gradient(135deg, var(--primary), var(--primary-light, #2563a8));
    color: #fff;
    box-shadow: 0 3px 12px rgba(26,58,92,0.25);
  }

  .btn-pdf-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 18px rgba(26,58,92,0.35); }

  .btn-pdf-secondary {
    background: #fff;
    color: var(--primary);
    border: 1px solid var(--border);
  }

  .btn-pdf-secondary:hover { border-color: var(--primary); background: #f0f4ff; }

  /* IQRAR */
  .iqrar-box {
    background: linear-gradient(135deg, #fffbf0, #fff8e6);
    border: 1px solid #f0d898;
    border-right: 4px solid var(--accent);
    border-radius: 14px;
    padding: 24px;
    margin-bottom: 20px;
    font-size: 0.9rem;
    line-height: 2;
    color: var(--text);
  }

  .iqrar-box h3 {
    font-family: 'Tajawal', sans-serif;
    font-size: 1.1rem;
    font-weight: 900;
    color: var(--primary);
    margin-bottom: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .iqrar-fields {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 14px;
    margin: 20px 0;
  }

  .iqrar-field {
    background: #fff;
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 12px 16px;
  }

  .iqrar-field label {
    display: block;
    font-size: 0.76rem;
    font-weight: 700;
    color: var(--muted);
    margin-bottom: 6px;
  }

  .iqrar-field span {
    font-size: 0.9rem;
    font-weight: 700;
    color: var(--primary);
  }

  .sign-area {
    border: 2px dashed var(--border);
    border-radius: 12px;
    background: #fff;
    height: 120px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: 8px;
    cursor: pointer;
    transition: all 0.25s;
    margin: 16px 0;
    position: relative;
    overflow: hidden;
  }

  .sign-area:hover { border-color: var(--accent); background: #fffbf0; }
  .sign-area.signed { border-color: var(--green-light); border-style: solid; background: #f0faf5; }

  .sign-area canvas {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
  }

  .sign-placeholder { color: var(--muted); font-size: 0.84rem; font-weight: 600; text-align: center; }
  .sign-placeholder span { font-size: 1.6rem; display: block; margin-bottom: 4px; }

  .iqrar-actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 16px; }

  .btn-sign {
    background: linear-gradient(135deg, var(--green), var(--green-light));
    color: #fff;
    border: none;
    padding: 12px 24px;
    border-radius: 10px;
    font-family: 'Cairo', sans-serif;
    font-size: 0.9rem;
    font-weight: 800;
    cursor: pointer;
    transition: all 0.25s;
    box-shadow: 0 4px 14px rgba(26,107,74,0.3);
  }

  .btn-sign:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(26,107,74,0.4); }

  .btn-clear-sign {
    background: #fff;
    color: var(--muted);
    border: 1px solid var(--border);
    padding: 12px 20px;
    border-radius: 10px;
    font-family: 'Cairo', sans-serif;
    font-size: 0.88rem;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-clear-sign:hover { border-color: #ef4444; color: #ef4444; }

  .signed-badge {
    display: none;
    background: #d1fae5;
    border: 1px solid #6ee7b7;
    color: #065f46;
    padding: 10px 18px;
    border-radius: 10px;
    font-size: 0.85rem;
    font-weight: 700;
    align-items: center;
    gap: 8px;
  }

  /* ADMIN PANEL */
  #admin-portal { display:none; }
  .admin-banner { background:linear-gradient(135deg,#7a2800 0%,#a33800 60%,#c25a00 100%); padding:22px 36px; display:flex; align-items:center; justify-content:space-between; border-bottom:4px solid #f59040; }
  .admin-badge { background:rgba(245,144,64,0.2); border:1px solid rgba(245,144,64,0.4); color:#f59040; padding:5px 16px; border-radius:20px; font-size:0.8rem; font-weight:700; }
  .admin-body { max-width:960px; margin:0 auto; padding:28px 36px 60px; }
  .admin-tabs { display:flex; gap:4px; background:#fff; border:1px solid var(--border); border-radius:14px; padding:6px; margin-bottom:26px; box-shadow:0 2px 12px rgba(0,0,0,0.04); }
  .admin-tab-btn { flex:1; padding:10px 8px; border:none; background:transparent; border-radius:9px; font-family:'Cairo',sans-serif; font-size:0.84rem; font-weight:700; color:var(--muted); cursor:pointer; transition:all 0.22s; display:flex; align-items:center; justify-content:center; gap:5px; }
  .admin-tab-btn.active { background:linear-gradient(135deg,#c25a00,#e07020); color:#fff; box-shadow:0 3px 12px rgba(194,90,0,0.35); }
  .admin-tab-pane { display:none; animation:fadeIn 0.3s ease; }
  .admin-tab-pane.active { display:block; }
  .students-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); gap:14px; }
  .stu-card { background:#fff; border:1px solid var(--border); border-radius:14px; padding:16px 18px; cursor:pointer; transition:all 0.2s; display:flex; align-items:center; gap:12px; }
  .stu-card:hover { border-color:#e07020; box-shadow:0 4px 18px rgba(194,90,0,0.12); transform:translateY(-2px); }
  .stu-card-avatar { width:44px; height:44px; border-radius:50%; background:linear-gradient(135deg,#fff3e0,#ffe0b2); display:flex; align-items:center; justify-content:center; font-size:1.3rem; flex-shrink:0; }
  .stu-card-name { font-weight:800; font-size:0.88rem; color:var(--primary); margin-bottom:3px; }
  .stu-card-meta { font-size:0.75rem; color:var(--muted); }
  .stu-card-pin { font-size:0.72rem; background:#fff3e0; color:#c25a00; padding:2px 8px; border-radius:8px; font-weight:700; }
  .modal-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center; padding:20px; }
  .modal-overlay.open { display:flex; }
  .modal-box { background:#fff; border-radius:20px; padding:32px; width:100%; max-width:560px; max-height:90vh; overflow-y:auto; box-shadow:0 24px 64px rgba(0,0,0,0.25); animation:fadeIn 0.2s ease; }
  .modal-title { font-family:'Tajawal',sans-serif; font-size:1.2rem; font-weight:900; color:var(--primary); margin-bottom:20px; display:flex; align-items:center; gap:8px; border-bottom:2px solid var(--border); padding-bottom:14px; }
  .form-group { margin-bottom:16px; }
  .form-label { display:block; font-size:0.8rem; font-weight:700; color:var(--muted); margin-bottom:6px; }
  .form-input { width:100%; padding:11px 14px; border:1.5px solid var(--border); border-radius:10px; font-family:'Cairo',sans-serif; font-size:0.88rem; color:var(--text); outline:none; transition:border-color 0.2s; }
  .form-input:focus { border-color:#e07020; box-shadow:0 0 0 3px rgba(224,112,32,0.1); }
  .form-actions { display:flex; gap:10px; margin-top:20px; flex-wrap:wrap; }
  .btn-save { background:linear-gradient(135deg,#c25a00,#e07020); color:#fff; border:none; padding:12px 24px; border-radius:10px; font-family:'Cairo',sans-serif; font-size:0.9rem; font-weight:800; cursor:pointer; transition:all 0.2s; box-shadow:0 4px 14px rgba(194,90,0,0.3); }
  .btn-save:hover { transform:translateY(-2px); }
  .btn-cancel { background:#fff; color:var(--muted); border:1px solid var(--border); padding:12px 20px; border-radius:10px; font-family:'Cairo',sans-serif; font-size:0.88rem; font-weight:700; cursor:pointer; }
  .btn-delete-student { background:#fff; color:#dc2626; border:1px solid #fecaca; padding:12px 20px; border-radius:10px; font-family:'Cairo',sans-serif; font-size:0.88rem; font-weight:700; cursor:pointer; margin-right:auto; }
  .btn-delete-student:hover { background:#fee2e2; }
  .goal-row { background:#f9fafb; border:1px solid var(--border); border-radius:10px; padding:12px 14px; margin-bottom:10px; position:relative; }
  .goal-row .form-input { margin-bottom:8px; }
  .goal-row .form-input:last-of-type { margin-bottom:0; }
  .btn-remove-goal { position:absolute; top:8px; left:8px; background:#fee2e2; color:#dc2626; border:none; border-radius:6px; width:26px; height:26px; cursor:pointer; font-size:0.8rem; display:flex; align-items:center; justify-content:center; }
  .btn-add-goal { background:#fff3e0; border:1.5px dashed #e07020; color:#c25a00; width:100%; padding:10px; border-radius:10px; font-family:'Cairo',sans-serif; font-size:0.85rem; font-weight:700; cursor:pointer; transition:all 0.2s; margin-top:8px; }
  .btn-add-goal:hover { background:#ffe0b2; }
  .fu-edit-row { display:grid; grid-template-columns:2fr 1fr 1fr 1fr 1fr 1fr 28px; gap:6px; align-items:center; margin-bottom:8px; }
  .fu-edit-row input, .fu-edit-row select { padding:8px 10px; border:1.5px solid var(--border); border-radius:8px; font-family:'Cairo',sans-serif; font-size:0.78rem; outline:none; width:100%; }
  .success-toast { position:fixed; bottom:30px; left:50%; transform:translateX(-50%); background:#c25a00; color:#fff; padding:12px 28px; border-radius:12px; font-weight:700; font-size:0.88rem; z-index:9999; box-shadow:0 8px 24px rgba(194,90,0,0.4); display:none; animation:fadeIn 0.3s ease; }

  /* RESPONSIVE */
  @media (max-width: 640px) {
    header { padding: 12px 18px; }
    .portal-banner { padding: 18px; }
    .portal-body { padding: 18px 16px 40px; }
    .tabs { flex-wrap: wrap; }
    .tab-btn { font-size: 0.75rem; padding: 8px 4px; }
    .login-card { padding: 32px 22px; }
  }
</style>
</head>
<body>

<header>
  <div class="header-left">
    <div class="header-icon">ğŸ“˜</div>
    <div>
      <div class="header-title">Ø¨ÙˆØ§Ø¨Ø© Ù…Ù„ÙØ§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ â€” Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„Ø¯Ù…Ø¬ Ø§Ù„ÙÙƒØ±ÙŠ</div>
      <div class="header-sub">Ù…Ø¯Ø±Ø³Ø© Ù…ÙƒØ© Ø§Ù„Ù…ÙƒØ±Ù…Ø© Ø§Ù„Ù…ØªÙˆØ³Ø·Ø© | Ù‚Ø³Ù… Ø°ÙˆÙŠ Ø§Ù„Ø¥Ø¹Ø§Ù‚Ø©</div>
    </div>
  </div>
  <a href="index.html" class="back-btn">â† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
</header>

<!-- ============ LOGIN ============ -->
<div id="login-screen">
  <div class="login-card">
    <div class="login-badge">ğŸ” Ø¨ÙˆØ§Ø¨Ø© Ø¢Ù…Ù†Ø©</div>
    <div class="login-icon-big">ğŸ“</div>
    <h2>Ø¨ÙˆØ§Ø¨Ø© Ù…Ù„ÙØ§Øª Ø§Ù„Ø·Ù„Ø§Ø¨</h2>
    <p class="login-desc">
      Ø£Ø¯Ø®Ù„ Ø¢Ø®Ø± 4 Ø£Ø±Ù‚Ø§Ù… Ù…Ù† Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠ Ù„Ù„Ø·Ø§Ù„Ø¨ Ù„Ù„Ø§Ø·Ù„Ø§Ø¹ Ø¹Ù„Ù‰ Ù…Ù„ÙÙ‡ Ø§Ù„ÙƒØ§Ù…Ù„
    </p>
    <div class="input-label">ğŸ”‘ Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ø¢Ø®Ø± 4 Ø£Ø±Ù‚Ø§Ù… Ù…Ù† Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠ)</div>
    <input type="password" class="pin-input" id="pin-input" maxlength="4" placeholder="â€¢ â€¢ â€¢ â€¢" autocomplete="off" oninput="this.value=this.value.replace(/[^0-9]/g,'')" onkeydown="if(event.key==='Enter') checkPin()">
    <div class="error-msg" id="error-msg">âŒ Ø§Ù„Ø±Ù…Ø² ØºÙŠØ± ØµØ­ÙŠØ­ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø¬Ø¯Ø¯Ø§Ù‹</div>
    <button class="login-btn" onclick="checkPin()">ğŸ”“ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¨ÙˆØ§Ø¨Ø©</button>
    <div class="hint-box">
      ğŸ’¡ <strong>Ù„Ø£ÙˆÙ„ÙŠØ§Ø¡ Ø§Ù„Ø£Ù…ÙˆØ±:</strong> Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù‡Ùˆ Ø¢Ø®Ø± 4 Ø£Ø±Ù‚Ø§Ù… Ù…Ù† Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠ Ù„Ø§Ø¨Ù†ÙƒÙ…. ÙÙŠ Ø­Ø§Ù„ ÙˆØ¬ÙˆØ¯ Ø£ÙŠ Ø§Ø³ØªÙØ³Ø§Ø± ØªÙˆØ§ØµÙ„ÙˆØ§ Ù…Ø¹ Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ù…Ø®ØªØµ.
    </div>
  </div>
</div>

<!-- ============ PORTAL ============ -->
<div id="student-portal">

  <div class="portal-banner">
    <div class="student-identity">
      <div class="student-photo-wrap">
        <div class="student-photo" id="student-photo-circle" onclick="document.getElementById('photo-input').click()">
          <img id="student-photo-img" src="" alt="" style="display:none;">
          <span id="student-photo-emoji">ğŸ“</span>
        </div>
        <button class="photo-change-btn" onclick="document.getElementById('photo-input').click()" title="ØªØºÙŠÙŠØ± Ø§Ù„ØµÙˆØ±Ø©">âœï¸</button>
        <input type="file" id="photo-input" class="photo-input" accept="image/*" onchange="uploadStudentPhoto(this)">
      </div>
      <div class="student-name-display" id="disp-name">â€”</div>
      <div class="student-meta-display">
        <span class="meta-chip" id="disp-grade">â€”</span>
        <span class="meta-chip">ğŸ“˜ Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„Ø¯Ù…Ø¬ Ø§Ù„ÙÙƒØ±ÙŠ</span>
        <span class="meta-chip" id="disp-id">â€”</span>
      </div>
    </div>
    <button class="logout-btn" onclick="logout()">ğŸšª Ø®Ø±ÙˆØ¬</button>
  </div>

  <div class="portal-body">

    <div class="tabs">
      <button class="tab-btn active" onclick="openTab('info',this)">ğŸ‘¤ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
      <button class="tab-btn" onclick="openTab('reports',this)">ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
      <button class="tab-btn" onclick="openTab('plan',this)">ğŸ“‹ Ø§Ù„Ø®Ø·Ø© Ø§Ù„ÙØ±Ø¯ÙŠØ©</button>
      <button class="tab-btn" onclick="openTab('iqrar',this)">âœï¸ Ø§Ù„Ø¥Ù‚Ø±Ø§Ø±</button>
    </div>

    <!-- INFO -->
    <div class="tab-pane active" id="tab-info">
      <div class="s-card">
        <div class="s-card-head">ğŸ‘¤ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨</div>
        <table class="info-tbl" id="info-tbl"></table>
      </div>
    </div>

    <!-- REPORTS -->
    <div class="tab-pane" id="tab-reports">
      <div class="s-card">
        <div class="s-card-head">ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„ÙˆØ«Ø§Ø¦Ù‚</div>
        <div id="reports-list"></div>
      </div>
    </div>

    <!-- PLAN -->
    <div class="tab-pane" id="tab-plan">
      <div class="s-card">
        <div class="s-card-head">ğŸ“‹ Ø§Ù„Ø®Ø·Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ© Ø§Ù„ÙØ±Ø¯ÙŠØ© â€” Ø§Ù„ÙØµÙ„ Ø§Ù„Ø«Ø§Ù†ÙŠ 1447Ù‡Ù€</div>
        <div style="padding:20px;" id="plan-pdfs"></div>
      </div>
    </div>

    <!-- IQRAR -->
    <div class="tab-pane" id="tab-iqrar">
      <div class="s-card">
        <div class="s-card-head">âœï¸ Ø¥Ù‚Ø±Ø§Ø± Ø§Ø·Ù„Ø§Ø¹ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø·Ø© Ø§Ù„ÙØ±Ø¯ÙŠØ©</div>
        <div style="padding:24px;" id="iqrar-content"></div>
      </div>
    </div>

  </div>
</div>

<!-- ============ ADMIN PORTAL ============ -->
<div id="admin-portal">
  <div class="admin-banner">
    <div style="display:flex;align-items:center;gap:14px;">
      <div style="width:46px;height:46px;border-radius:12px;background:rgba(245,144,64,0.2);border:1px solid rgba(245,144,64,0.35);display:flex;align-items:center;justify-content:center;font-size:1.4rem;">ğŸ”§</div>
      <div>
        <div style="color:#fff;font-family:'Tajawal',sans-serif;font-size:1.1rem;font-weight:900;">Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø´Ø±Ù â€” Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„Ø¯Ù…Ø¬ Ø§Ù„ÙÙƒØ±ÙŠ</div>
        <div style="color:rgba(255,255,255,0.55);font-size:0.76rem;margin-top:2px;">Ù…Ø¯Ø±Ø³Ø© Ù…ÙƒØ© Ø§Ù„Ù…ÙƒØ±Ù…Ø© Ø§Ù„Ù…ØªÙˆØ³Ø·Ø© | Ù‚Ø³Ù… Ø°ÙˆÙŠ Ø§Ù„Ø¥Ø¹Ø§Ù‚Ø©</div>
      </div>
    </div>
    <div style="display:flex;align-items:center;gap:12px;">
      <div class="admin-badge" id="admin-student-count">â€” Ø·Ø§Ù„Ø¨</div>
      <button class="logout-btn" onclick="adminLogout()">ğŸšª Ø®Ø±ÙˆØ¬</button>
    </div>
  </div>
  <div class="admin-body">
    <div class="admin-tabs">
      <button class="admin-tab-btn active" onclick="openAdminTab('list',this)">ğŸ‘¨â€ğŸ“ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</button>
      <button class="admin-tab-btn" onclick="openAdminTab('add',this)">â• Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨</button>
    </div>
    <div class="admin-tab-pane active" id="admin-tab-list">
      <div style="margin-bottom:14px;">
        <input type="text" class="form-input" id="admin-search" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ø£Ùˆ Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„..." oninput="renderStudentCards()" style="max-width:400px;">
      </div>
      <div class="students-grid" id="students-grid"></div>
    </div>
    <div class="admin-tab-pane" id="admin-tab-add">
      <div class="s-card">
        <div class="s-card-head">â• Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</div>
        <div style="padding:24px;">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
            <div class="form-group">
              <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„ÙƒØ§Ù…Ù„ *</label>
              <input type="text" class="form-input" id="new-name" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø­Ù…Ø¯ Ø£Ø­Ù…Ø¯ Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ">
            </div>
            <div class="form-group">
              <label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠ / Ø§Ù„Ø¥Ù‚Ø§Ù…Ø© *</label>
              <input type="text" class="form-input" id="new-id" placeholder="10 Ø£Ø±Ù‚Ø§Ù…" maxlength="10">
            </div>
            <div class="form-group">
              <label class="form-label">Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ *</label>
              <input type="text" class="form-input" id="new-grade" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ù…ØªÙˆØ³Ø· / 1">
            </div>
            <div class="form-group">
              <label class="form-label">Ø¬ÙˆØ§Ù„ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</label>
              <input type="text" class="form-input" id="new-phone" placeholder="05xxxxxxxx">
            </div>
          </div>
          <div class="form-group" style="margin-top:8px;">
            <label class="form-label">ğŸ’¡ Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ø¢Ø®Ø± 4 Ø£Ø±Ù‚Ø§Ù… Ù…Ù† Ø§Ù„Ø³Ø¬Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹)</label>
            <input type="text" class="form-input" id="new-pin-preview" placeholder="ÙŠÙØ­Ø³Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹" readonly style="background:#f9f9f9;color:var(--muted);">
          </div>
          <button class="btn-save" onclick="addNewStudent()" style="margin-top:8px;">âœ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø§Ù„Ø¨</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- EDIT MODAL -->
<div class="modal-overlay" id="edit-modal">
  <div class="modal-box">
    <div class="modal-title" id="modal-title">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨</div>
    <div style="display:flex;gap:4px;background:#f5f2eb;border-radius:10px;padding:4px;margin-bottom:20px;">
      <button class="admin-tab-btn active" onclick="openEditTab('basic',this)" style="font-size:0.78rem;padding:7px 4px;">ğŸ‘¤ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
      <button class="admin-tab-btn" onclick="openEditTab('plan',this)" style="font-size:0.78rem;padding:7px 4px;">ğŸ“‹ Ø§Ù„Ø®Ø·Ø©</button>
      <button class="admin-tab-btn" onclick="openEditTab('followup',this)" style="font-size:0.78rem;padding:7px 4px;">ğŸ“Š Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©</button>
    </div>
    <div id="edit-tab-basic">
      <div class="form-group"><label class="form-label">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</label><input type="text" class="form-input" id="edit-name"></div>
      <div class="form-group"><label class="form-label">Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ</label><input type="text" class="form-input" id="edit-grade"></div>
      <div class="form-group"><label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠ / Ø§Ù„Ø¥Ù‚Ø§Ù…Ø©</label><input type="text" class="form-input" id="edit-id"></div>
      <div class="form-group"><label class="form-label">Ø¬ÙˆØ§Ù„ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</label><input type="text" class="form-input" id="edit-phone"></div>
    </div>
    <div id="edit-tab-plan" style="display:none;">
      <div id="plan-goals-editor"></div>
      <button class="btn-add-goal" onclick="addGoalRow()">+ Ø¥Ø¶Ø§ÙØ© Ù‡Ø¯Ù Ø¬Ø¯ÙŠØ¯</button>
    </div>
    <div id="edit-tab-followup" style="display:none;">
      <div style="font-size:0.78rem;color:var(--muted);margin-bottom:10px;background:#fff3e0;padding:10px;border-radius:8px;">âœ“ = Ø­Ù‚Ù‚ &nbsp;|&nbsp; ~ = Ø¬Ø²Ø¦ÙŠØ§Ù‹ &nbsp;|&nbsp; âœ— = Ù„Ù… ÙŠØ­Ù‚Ù‚</div>
      <div style="display:grid;grid-template-columns:2fr 1fr 1fr 1fr 1fr 1fr 28px;gap:6px;margin-bottom:8px;">
        <div style="font-size:0.75rem;font-weight:700;color:var(--muted);text-align:center;">Ø§Ù„Ù…Ù‡Ø§Ø±Ø©</div>
        <div style="font-size:0.75rem;font-weight:700;color:var(--muted);text-align:center;">Ù…Ù¡</div>
        <div style="font-size:0.75rem;font-weight:700;color:var(--muted);text-align:center;">Ù…Ù¢</div>
        <div style="font-size:0.75rem;font-weight:700;color:var(--muted);text-align:center;">Ù…Ù£</div>
        <div style="font-size:0.75rem;font-weight:700;color:var(--muted);text-align:center;">Ù…Ù¤</div>
        <div style="font-size:0.75rem;font-weight:700;color:var(--muted);text-align:center;">Ù…Ù¥</div>
        <div></div>
      </div>
      <div id="followup-editor"></div>
      <button class="btn-add-goal" onclick="addFollowupRow()">+ Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ø§Ø±Ø©</button>
    </div>
    <div class="form-actions">
      <button class="btn-delete-student" onclick="deleteStudent()">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨</button>
      <button class="btn-cancel" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="btn-save" onclick="saveStudentEdits()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="success-toast" id="success-toast">âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­</div>

<script>
// =====================================================
// Supabase Config
// =====================================================
const SUPABASE_URL = "https://pyrxwqgapwjwhiskowhk.supabase.co";
const SUPABASE_KEY = "sb_publishable_bfe-B4f-Rag1SR0-PoIb9w_nMfA1Ere";
const ADMIN_PIN = "7410"; // Ø±Ù…Ø² Ù…Ø´Ø±Ù Ø§Ù„Ø¯Ù…Ø¬

async function sbSaveSignature(pin, name, grade, signData) {
  try {
    await fetch(SUPABASE_URL + '/rest/v1/signatures', {
      method: 'POST',
      headers: {
        'apikey': SUPABASE_KEY,
        'Authorization': 'Bearer ' + SUPABASE_KEY,
        'Content-Type': 'application/json',
        'Prefer': 'return=minimal'
      },
      body: JSON.stringify({
        student_pin: pin,
        student_name: name,
        grade: grade,
        signature_data: signData
      })
    });
    console.log('âœ… Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ Ø­ÙÙØ¸ ÙÙŠ Supabase');
  } catch(e) {
    console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹:', e);
  }
}

// =====================================================
// Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ â€” Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„Ø¯Ù…Ø¬ Ø§Ù„ÙÙƒØ±ÙŠ
// Ø§Ù„Ø±Ù…Ø² = Ø¢Ø®Ø± 4 Ø£Ø±Ù‚Ø§Ù… Ù…Ù† Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠ
// =====================================================
// =====================================================
// Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„Ø®Ø·Ø· Ù„ÙƒÙ„ Ø·Ø§Ù„Ø¨
// math: 1 Ø£Ùˆ 2 | arabic: 1 Ø£Ùˆ 2
// Ø¹Ø¯Ù‘Ù„ Ù‡Ù†Ø§ ÙÙ‚Ø· Ù„ØªØºÙŠÙŠØ± Ù…Ø³ØªÙˆÙ‰ Ø£ÙŠ Ø·Ø§Ù„Ø¨
// =====================================================


const BASE_URL = "https://makkah-special.github.io/";

const STUDENTS = {
  // ===== Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ù…ØªÙˆØ³Ø· =====
  "7405": { name: "Ø§ÙŠØ§Ø¯ Ù…ÙˆØ³Ù‰ Ø­ÙˆÙ„ÙŠ Ø§Ù„Ù‚Ø±Ù†ÙŠ",        id_full: "1152837405", grade: "Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ù…ØªÙˆØ³Ø· / Ù¡",  phone: "0500000000", plan: [], reports: [], followup: [] },
  "4526": { name: "Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ ØµØ§Ù„Ø­ Ø£Ø­Ù…Ø¯ Ø§Ù„Ù…Ø´Ø¬Ø±ÙŠ",     id_full: "2297474526", grade: "Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ù…ØªÙˆØ³Ø· / Ù¡",  phone: "0500000000", plan: [], reports: [], followup: [] },
  "9050": { name: "Ø¹Ù„ÙŠ Ù…Ø­Ù…Ø¯ Ù…Ø·Ø± Ø§Ù„Ø³Ù‡ÙŠÙ…ÙŠ",          id_full: "1158819050", grade: "Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ù…ØªÙˆØ³Ø· / Ù¡",  phone: "0500000000", plan: [], reports: [], followup: [] },
  "4612": { name: "Ù…Ø­Ù…Ø¯ Ø¹Ù„ÙŠ Ù…Ø­Ù…Ø¯ Ø§Ù„Ù…Ù†ØªØ´Ø±ÙŠ",        id_full: "1153884612", grade: "Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ù…ØªÙˆØ³Ø· / Ù¡",  phone: "0500000000", plan: [], reports: [], followup: [] },
  "0977": { name: "Ù…Ø´Ø§Ø±ÙŠ ÙÙŠØ­Ø§Ù† Ø³Ù…ÙŠØ­ Ø§Ù„Ø¨Ù‚Ù…ÙŠ",      id_full: "1149660977", grade: "Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ù…ØªÙˆØ³Ø· / Ù¡",  phone: "0500000000", plan: [], reports: [], followup: [] },
  "6630": { name: "ÙŠØ²Ù† Ù…Ø­Ù…Ø¯ Ù…ØµÙ„Ø­ Ø³Ù„Ø§Ù…ÙŠ",          id_full: "1166376630", grade: "Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ù…ØªÙˆØ³Ø· / Ù¡",  phone: "0500000000", plan: [], reports: [], followup: [] },
  // ===== Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ù…ØªÙˆØ³Ø· =====
  "7543": { name: "Ø§Ø­Ù…Ø¯ Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ù…Ø¹Ø·ÙŠ Ø§Ù„Ø¬Ø¯Ø¹Ø§Ù†ÙŠ",   id_full: "1151467543", grade: "Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ù…ØªÙˆØ³Ø· / Ù¡", phone: "0500000000", plan: [], reports: [], followup: [] },
  "4218": { name: "Ø±Ø§ÙƒØ§Ù† Ø³Ù…ÙŠØ± ÙÙ‚ÙŠÙ‡ÙŠ Ø§Ù„ÙŠÙ…Ø§Ù†ÙŠ",      id_full: "1205014218", grade: "Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ù…ØªÙˆØ³Ø· / Ù¡", phone: "0500000000", plan: [], reports: [], followup: [] },
  "7892": { name: "Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø­Ù…Ù† Ø­Ø³Ù† Ø³Ø¹Ø¯ Ø§Ù„Ù‚Ø­Ø·Ø§Ù†ÙŠ",   id_full: "1144197892", grade: "Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ù…ØªÙˆØ³Ø· / Ù¡", phone: "0500000000", plan: [], reports: [], followup: [] },
  "4304": { name: "ÙÙ‡Ø¯ Ø¹Ù„ÙŠ Ø­Ø³ÙŠÙ† Ø§Ù„ØµÙˆÙ…Ø§Ù„ÙŠ",        id_full: "1160744304", grade: "Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ù…ØªÙˆØ³Ø· / Ù¡", phone: "0500000000", plan: [], reports: [], followup: [] },
  // ===== Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ù…ØªÙˆØ³Ø· =====
  "4511": { name: "Ø­Ø³Ù† Ø®Ø§Ù„Ø¯ Ø­Ø³Ù† ØµØºÙŠØ±",           id_full: "1150674511", grade: "Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ù…ØªÙˆØ³Ø· / Ù¡", phone: "0500000000", plan: [], reports: [], followup: [] },
  "6984": { name: "Ø®Ø§Ù„Ø¯ Ø§Ø¨Ø±Ø§Ù‡ÙŠÙ… Ù…Ù†ØµÙˆØ± Ø§Ù„Ø¹Ø§Ù…Ø±ÙŠ",    id_full: "1159536984", grade: "Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ù…ØªÙˆØ³Ø· / Ù¡", phone: "0500000000", plan: [], reports: [], followup: [] },
  "5210": { name: "Ø³Ø§Ù…ÙŠ Ø§Ù‚Ø¨Ø§Ù„ Ø£Ø­Ù…Ø¯ Ø£Ø­Ù…Ø¯",         id_full: "2293985210", grade: "Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ù…ØªÙˆØ³Ø· / Ù¡", phone: "0500000000", plan: [], reports: [], followup: [] },
  "4447": { name: "Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø§Ø­Ù…Ø¯ Ø¨Ù† Ø§Ø¨Ø±Ø§Ù‡ÙŠÙ… Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ", id_full: "1157024447", grade: "Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ù…ØªÙˆØ³Ø· / Ù¡", phone: "0500000000", plan: [], reports: [], followup: [] },
  "5460": { name: "Ù…Ø§Ø¬Ø¯ Ù†Ø§Ø¯Ø± Ø£Ø­Ù…Ø¯ Ø¹ÙŠØ³Ù‰",          id_full: "1162795460", grade: "Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ù…ØªÙˆØ³Ø· / Ù¡", phone: "0500000000", plan: [], reports: [], followup: [] },
  "7907": { name: "Ù…Ø­Ù…Ø¯ Ø³Ù„ÙŠÙ…Ø§Ù† Ø§Ø¨Ø±Ø§Ù‡ÙŠÙ… Ø·ÙˆØ§Ø´ÙŠ",    id_full: "1148347907", grade: "Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ù…ØªÙˆØ³Ø· / Ù¡", phone: "0500000000", plan: [], reports: [], followup: [] },
  "8315": { name: "Ù…Ø´Ø§Ø±ÙŠ Ø®Ù„ÙŠÙ„ Ø§Ø¨Ø±Ø§Ù‡ÙŠÙ… Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ",  id_full: "1204218315", grade: "Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ù…ØªÙˆØ³Ø· / Ù¡", phone: "0500000000", plan: [], reports: [], followup: [] },
  "2407": { name: "Ù…Ù‡Ù†Ø¯ Ù…Ø­Ù…Ø¯ Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø§Ù„Ø´Ù‡Ø±ÙŠ",     id_full: "1145092407", grade: "Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ù…ØªÙˆØ³Ø· / Ù¡", phone: "0500000000", plan: [], reports: [], followup: [] },
  "9867": { name: "Ù…Ø¤ÙŠØ¯ Ù…Ø´Ø¹Ù„ Ø¹Ù„ÙŠ Ø§Ù„Ø¹Ù…Ø±ÙŠ",         id_full: "1137239867", grade: "Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ù…ØªÙˆØ³Ø· / Ù¡", phone: "0500000000", plan: [], reports: [], followup: [] },
  "2335": { name: "Ù…Ø¤ÙŠØ¯ Ù†Ø¹ÙŠÙ… Ø§Ø¨Ø±Ø§Ù‡ÙŠÙ… Ø¨Ø¯ÙŠØ±",       id_full: "2288502335", grade: "Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ù…ØªÙˆØ³Ø· / Ù¡", phone: "0500000000", plan: [], reports: [], followup: [] },
  "9258": { name: "ÙˆÙ„ÙŠØ¯ Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ ÙŠØ­ÙŠ Ø§Ù„Ø´Ù‡Ø±ÙŠ",      id_full: "1152469258", grade: "Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ù…ØªÙˆØ³Ø· / Ù¡", phone: "0500000000", plan: [], reports: [], followup: [] },
}
// =====================================================
// LOGIC
// =====================================================
let currentStudent = null;

// ===== STUDENT PHOTO =====
const SB_PHOTOS = "https://pyrxwqgapwjwhiskowhk.supabase.co/storage/v1/object/public/reports/dumaj/photos/";
const SB_URL    = "https://pyrxwqgapwjwhiskowhk.supabase.co";
const SB_KEY    = "sb_publishable_bfe-B4f-Rag1SR0-PoIb9w_nMfA1Ere";

async function loadStudentPhoto(pin) {
  const exts = ['jpg','jpeg','png','webp'];
  for (const ext of exts) {
    const url = `${SB_PHOTOS}photo-${pin}.${ext}`;
    try {
      const r = await fetch(url, { method: 'HEAD' });
      if (r.ok) {
        document.getElementById('student-photo-img').src = url;
        document.getElementById('student-photo-img').style.display = 'block';
        document.getElementById('student-photo-emoji').style.display = 'none';
        break;
      }
    } catch(e) {}
  }
}

async function uploadStudentPhoto(input) {
  const file = input.files[0];
  if (!file) return;
  const pin = currentStudent?.pin;
  if (!pin) return;
  const ext = file.name.split('.').pop();
  const fileName = `reports/dumaj/photos/photo-${pin}.${ext}`;
  const reader = new FileReader();
  reader.onload = e => {
    document.getElementById('student-photo-img').src = e.target.result;
    document.getElementById('student-photo-img').style.display = 'block';
    document.getElementById('student-photo-emoji').style.display = 'none';
  };
  reader.readAsDataURL(file);
  try {
    await fetch(`${SB_URL}/storage/v1/object/${fileName}`, {
      method: 'POST',
      headers: { 'apikey': SB_KEY, 'Authorization': 'Bearer ' + SB_KEY, 'Content-Type': file.type, 'x-upsert': 'true' },
      body: file
    });
  } catch(e) { console.error('Ø®Ø·Ø£:', e); }
}

function loadStudent(pin) {
  const s = STUDENTS[pin];
  s.pin = pin;
  currentStudent = s;

  document.getElementById('disp-name').textContent = s.name;
  document.getElementById('student-photo-img').style.display = 'none';
  document.getElementById('student-photo-emoji').style.display = 'block';
  loadStudentPhoto(pin);
  document.getElementById('disp-grade').textContent = s.grade === 'Ø§Ù†ØªØ³Ø§Ø¨' ? 'ğŸ“‹ Ø§Ù†ØªØ³Ø§Ø¨' : 'ğŸ« ' + s.grade;
  document.getElementById('disp-id').textContent = 'Ø§Ù„Ø³Ø¬Ù„: ' + s.id_full;

  // PLAN â€” Ù…Ù† Supabase ÙÙ‚Ø·
  const SB_PLAN = "https://pyrxwqgapwjwhiskowhk.supabase.co/storage/v1/object/public/reports/dumaj/";

  document.getElementById('plan-pdfs').innerHTML = `
    <div class="pdf-section" id="custom-plan-section" style="display:none;">
      <div class="pdf-section-title">ğŸ“‹ Ø§Ù„Ø®Ø·Ø© Ø§Ù„ÙØ±Ø¯ÙŠØ© Ø§Ù„Ù…Ø®ØµØµØ©</div>
      <div class="pdf-frame-wrap" id="custom-plan-frame"></div>
      <div class="pdf-actions" id="custom-plan-actions"></div>
    </div>
    <div id="no-plan-msg" style="text-align:center;padding:40px;color:#9ca3af;">
      <div style="font-size:2.5rem;margin-bottom:12px;">ğŸ“‹</div>
      <div style="font-weight:700;font-size:0.95rem;">Ù„Ù… ÙŠØªÙ… Ø±ÙØ¹ Ø§Ù„Ø®Ø·Ø© Ø§Ù„ÙØ±Ø¯ÙŠØ© Ø¨Ø¹Ø¯</div>
      <div style="font-size:0.8rem;margin-top:6px;">Ø³ÙŠØªÙ… Ø¥Ø´Ø¹Ø§Ø±Ùƒ Ø¹Ù†Ø¯ Ø¥Ø¶Ø§ÙØªÙ‡Ø§</div>
    </div>
  `;

  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø®Ø·Ø© ÙÙŠ Supabase
  (async () => {
    const exts = ['pdf','PDF','docx','doc'];
    for (const ext of exts) {
      const url = `${SB_PLAN}plan-${pin}.${ext}`;
      try {
        const res = await fetch(url, { method: 'HEAD' });
        if (res.ok) {
          document.getElementById('no-plan-msg').style.display = 'none';
          document.getElementById('custom-plan-section').style.display = 'block';
          document.getElementById('custom-plan-frame').innerHTML =
            ext === 'pdf' || ext === 'PDF'
              ? `<iframe src="${url}" title="Ø§Ù„Ø®Ø·Ø© Ø§Ù„ÙØ±Ø¯ÙŠØ© Ø§Ù„Ù…Ø®ØµØµØ©"></iframe>`
              : `<div style="padding:20px;text-align:center;color:#5a6478;font-size:0.88rem;">ğŸ“ Ù…Ù„Ù Ø§Ù„Ø®Ø·Ø© Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ­Ù…ÙŠÙ„</div>`;
          document.getElementById('custom-plan-actions').innerHTML = `
            <a href="${url}" target="_blank" class="btn-pdf btn-pdf-primary">ğŸ”— ÙØªØ­ Ø§Ù„Ø®Ø·Ø©</a>
            <a href="${url}" download class="btn-pdf btn-pdf-secondary">â¬‡ï¸ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø·Ø© Ø§Ù„ÙØ±Ø¯ÙŠØ©</a>
          `;
          break;
        }
      } catch(e) {}
    }
  })();

  // REPORTS
  const rl = document.getElementById('reports-list');
  const studentPin = s.pin || Object.keys(STUDENTS).find(k => STUDENTS[k] === s) || '';
  const SB_STORAGE = "https://pyrxwqgapwjwhiskowhk.supabase.co/storage/v1/object/public/reports/dumaj/";

  // Ø¯Ø§Ù„Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ù„Ù
  async function checkFile(url) {
    try {
      const r = await fetch(url, { method: 'HEAD' });
      return r.ok;
    } catch { return false; }
  }

  // Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø«Ø§Ø¨ØªØ© Ù„ÙƒÙ„ Ø·Ø§Ù„Ø¨
  const fixedReports = [
    { title: "Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†ÙØ³ÙŠ Ø§Ù„Ù…ÙˆØ­Ø¯", icon: "ğŸ§ ", bg: "#ede9fe", tag: "Ù†ÙØ³ÙŠ", tagClass: "tag-purple", date: "Ø§Ù„ÙØµÙ„ Ø§Ù„Ø«Ø§Ù†ÙŠ 1447", fileKey: `psych-${studentPin}` },
    { title: "Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø·Ø¨ÙŠ",          icon: "ğŸ¥", bg: "#dbeafe", tag: "Ø·Ø¨ÙŠ",  tagClass: "tag-blue",   date: "Ø§Ù„ÙØµÙ„ Ø§Ù„Ø«Ø§Ù†ÙŠ 1447", fileKey: `medical-${studentPin}` },
  ];

  const reportsWithFiles = s.reports.map((r, i) => ({
    ...r,
    fileKey: r.fileKey || `report${i+1}-${studentPin}`
  }));

  const allReports = [...fixedReports, ...reportsWithFiles];

  // Ø±Ø³Ù… Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø£ÙˆÙ„Ø§Ù‹
  rl.innerHTML = allReports.map((r, idx) => `
    <div class="report-row">
      <div class="report-left">
        <div class="report-icon" style="background:${r.bg}">${r.icon}</div>
        <div>
          <div class="report-name">${r.title}</div>
          <div class="report-date">ğŸ“… ${r.date}</div>
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:8px;">
        <span class="tag ${r.tagClass}">${r.tag}</span>
        <span id="dl-btn-${idx}" class="btn-download-report" style="opacity:0.4;cursor:default;">â³</span>
      </div>
    </div>
  `).join('');

  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ÙƒÙ„ Ù…Ù„Ù ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø²Ø±Ø§Ø±
  allReports.forEach(async (r, idx) => {
    const extensions = ['pdf', 'PDF', 'docx', 'doc', 'jpg', 'png'];
    let found = false;
    for (const ext of extensions) {
      const url = `${SB_STORAGE}${r.fileKey}.${ext}`;
      const exists = await checkFile(url);
      if (exists) {
        const btn = document.getElementById(`dl-btn-${idx}`);
        if (btn) {
          btn.outerHTML = `<a href="${url}" download target="_blank" class="btn-download-report" title="ØªØ­Ù…ÙŠÙ„ ${r.title}">â¬‡ï¸ ØªØ­Ù…ÙŠÙ„</a>`;
        }
        found = true;
        break;
      }
    }
    if (!found) {
      const btn = document.getElementById(`dl-btn-${idx}`);
      if (btn) { btn.textContent = 'â€”'; btn.style.opacity = '0.3'; }
    }
  });

  // INFO
  const it = document.getElementById('info-tbl');
  it.innerHTML = `
    <tr><th>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th><td>${s.name}</td></tr>
    <tr><th>Ø±Ù‚Ù… Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠ</th><td>${s.id_full}</td></tr>
    <tr><th>Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ</th><td>${s.grade}</td></tr>
    <tr><th>Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬</th><td><span class="tag tag-green">ğŸ“˜ Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„Ø¯Ù…Ø¬ Ø§Ù„ÙÙƒØ±ÙŠ</span></td></tr>
    <tr><th>Ø¬ÙˆØ§Ù„ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</th><td><a href="tel:${s.phone}" style="color:var(--green); font-weight:700;">${s.phone}</a></td></tr>
    <tr><th>Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ</th><td>1447Ù‡Ù€</td></tr>
    <tr><th>Ø§Ù„ÙØµÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ</th><td>Ø§Ù„ÙØµÙ„ Ø§Ù„Ø«Ø§Ù†ÙŠ</td></tr>
  `;

  // IQRAR
  const today = new Date();
  const dateStr = today.toLocaleDateString('ar-SA-u-nu-latn', { year:'numeric', month:'long', day:'numeric' });
  document.getElementById('iqrar-content').innerHTML = `
    <div class="iqrar-box">
      <h3>ğŸ“„ Ù†Øµ Ø§Ù„Ø¥Ù‚Ø±Ø§Ø±</h3>
      <p>
        Ø£Ù†Ø§ ÙˆÙ„ÙŠ Ø£Ù…Ø± Ø§Ù„Ø·Ø§Ù„Ø¨ / <strong>${s.name}</strong>ØŒ Ø£ÙÙ‚Ø±Ù‘ Ø¨Ø£Ù†Ù†ÙŠ Ø§Ø·Ù„Ø¹ØªÙ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø·Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ© Ø§Ù„ÙØ±Ø¯ÙŠØ© Ø§Ù„Ù…ÙØ¹Ø¯ÙÙ‘Ø© Ù„Ø§Ø¨Ù†ÙŠ
        Ù„Ù„ÙØµÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ Ø§Ù„Ø«Ø§Ù†ÙŠ Ù…Ù† Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ 1447Ù‡Ù€ØŒ ÙˆØ£Ù†Ù†ÙŠ Ø¹Ù„Ù‰ Ø¯Ø±Ø§ÙŠØ© Ø¨Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‡Ø¯Ø§Ù ÙˆØ§Ù„Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„Ù…Ø°ÙƒÙˆØ±Ø© ÙÙŠÙ‡Ø§ØŒ
        ÙˆØ£ØªØ¹Ù‡Ø¯ Ø¨Ø§Ù„ØªØ¹Ø§ÙˆÙ† Ù…Ø¹ ÙØ±ÙŠÙ‚ Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„Ø¯Ù…Ø¬ Ø§Ù„ÙÙƒØ±ÙŠ Ù„ØªØ­Ù‚ÙŠÙ‚ Ø£ÙØ¶Ù„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù„Ø§Ø¨Ù†ÙŠ.
      </p>
    </div>

    <div class="iqrar-fields">
      <div class="iqrar-field">
        <label>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</label>
        <span>${s.name}</span>
      </div>
      <div class="iqrar-field">
        <label>Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ</label>
        <span>${s.grade}</span>
      </div>
      <div class="iqrar-field">
        <label>Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬</label>
        <span>ğŸ“˜ Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„Ø¯Ù…Ø¬ Ø§Ù„ÙÙƒØ±ÙŠ</span>
      </div>
      <div class="iqrar-field">
        <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù‚Ø±Ø§Ø±</label>
        <span id="iqrar-date">${dateStr}</span>
      </div>
    </div>

    <div style="font-size:0.84rem; font-weight:700; color:var(--primary); margin-bottom:8px;">âœï¸ ØªÙˆÙ‚ÙŠØ¹ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± (Ø§Ø±Ø³Ù… ØªÙˆÙ‚ÙŠØ¹Ùƒ Ø¨Ø§Ù„Ø£Ø³ÙÙ„)</div>
    <div class="sign-area" id="sign-area">
      <canvas id="sign-canvas"></canvas>
      <div class="sign-placeholder" id="sign-placeholder">
        <span>âœï¸</span>
        Ø§Ø¶ØºØ· Ù‡Ù†Ø§ ÙˆØ§Ø±Ø³Ù… ØªÙˆÙ‚ÙŠØ¹Ùƒ
      </div>
    </div>

    <div class="iqrar-actions">
      <button class="btn-sign" onclick="submitIqrar()">âœ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ù‚Ø±Ø§Ø± ÙˆØ§Ù„ØªÙˆÙ‚ÙŠØ¹</button>
      <button class="btn-clear-sign" onclick="clearSign()">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹</button>
      <button id="btn-save-pdf" onclick="saveIqrarPDF()" style="display:none; align-items:center; gap:7px; padding:9px 18px; border-radius:9px; background:linear-gradient(135deg,#1a3a5c,#2563a8); color:#fff; border:none; font-family:'Cairo',sans-serif; font-size:0.84rem; font-weight:700; cursor:pointer; box-shadow:0 3px 12px rgba(26,58,92,0.3);">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© / Ø­ÙØ¸ PDF</button>
    </div>

    <div class="signed-badge" id="signed-badge">
      âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¥Ù‚Ø±Ø§Ø±Ùƒ Ø¨Ù†Ø¬Ø§Ø­ â€” Ø´ÙƒØ±Ø§Ù‹ Ù„ØªØ¹Ø§ÙˆÙ†ÙƒÙ…
    </div>
  `;

  // Initialize signature canvas
  initCanvas();

  // SHOW PORTAL
  // Reset to first tab (info)
  document.querySelectorAll('.tab-btn').forEach((b,i) => b.classList.toggle('active', i===0));
  document.querySelectorAll('.tab-pane').forEach((p,i) => p.classList.toggle('active', i===0));

  document.getElementById('login-screen').style.display = 'none';
  document.getElementById('student-portal').style.display = 'block';
  window.scrollTo(0, 0);
}

function logout() {
  currentStudent = null;
  document.getElementById('pin-input').value = '';
  document.getElementById('student-portal').style.display = 'none';
  document.getElementById('login-screen').style.display = 'flex';
  // Reset tabs
  document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
  document.getElementById('tab-plan').classList.add('active');
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelector('.tab-btn').classList.add('active');
}

function openTab(id, btn) {
  document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('tab-' + id).classList.add('active');
  btn.classList.add('active');
  // Init canvas when iqrar tab is opened
  if (id === 'iqrar') setTimeout(initCanvas, 100);
}

// Legend
// =====================================================
// SIGNATURE CANVAS
// =====================================================
let isDrawing = false;
let signCanvas, signCtx;

function initCanvas() {
  setTimeout(() => {
    signCanvas = document.getElementById('sign-canvas');
    if (!signCanvas) return;
    const area = document.getElementById('sign-area');
    signCanvas.width = area.offsetWidth;
    signCanvas.height = area.offsetHeight;
    signCtx = signCanvas.getContext('2d');
    signCtx.strokeStyle = '#1a3a5c';
    signCtx.lineWidth = 2.5;
    signCtx.lineCap = 'round';
    signCtx.lineJoin = 'round';

    signCanvas.addEventListener('mousedown', startDraw);
    signCanvas.addEventListener('mousemove', draw);
    signCanvas.addEventListener('mouseup', stopDraw);
    signCanvas.addEventListener('mouseleave', stopDraw);
    signCanvas.addEventListener('touchstart', e => { e.preventDefault(); startDraw(e.touches[0]); }, {passive:false});
    signCanvas.addEventListener('touchmove', e => { e.preventDefault(); draw(e.touches[0]); }, {passive:false});
    signCanvas.addEventListener('touchend', stopDraw);
  }, 150);
}

function getPos(e) {
  const rect = signCanvas.getBoundingClientRect();
  return {
    x: (e.clientX - rect.left) * (signCanvas.width / rect.width),
    y: (e.clientY - rect.top) * (signCanvas.height / rect.height)
  };
}

function startDraw(e) {
  isDrawing = true;
  let pos = getPos(e);
  signCtx.beginPath();
  signCtx.moveTo(pos.x, pos.y);
  document.getElementById('sign-placeholder').style.display = 'none';
  document.getElementById('sign-area').classList.add('signed');
}

function draw(e) {
  if (!isDrawing) return;
  let pos = getPos(e);
  signCtx.lineTo(pos.x, pos.y);
  signCtx.stroke();
}

function stopDraw() { isDrawing = false; }

function clearSign() {
  if (!signCtx) return;
  signCtx.clearRect(0, 0, signCanvas.width, signCanvas.height);
  const ph = document.getElementById('sign-placeholder');
  if (ph) ph.style.display = 'flex';
  document.getElementById('sign-area').classList.remove('signed');
  document.getElementById('signed-badge').style.display = 'none';
  const btnClear = document.querySelector('.btn-sign');
  if (btnClear) { btnClear.textContent = 'âœ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ù‚Ø±Ø§Ø± ÙˆØ§Ù„ØªÙˆÙ‚ÙŠØ¹'; btnClear.disabled = false; btnClear.style.opacity = '1'; }
}

async function submitIqrar() {
  if (!signCanvas) return;
  const data = signCtx.getImageData(0, 0, signCanvas.width, signCanvas.height).data;
  const hasDrawing = Array.from(data).some((v, i) => i % 4 === 3 && v > 0);
  if (!hasDrawing) {
    alert('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø±Ø³Ù… ØªÙˆÙ‚ÙŠØ¹Ùƒ ÙÙŠ Ø§Ù„Ù…Ø±Ø¨Ø¹ Ø£ÙˆÙ„Ø§Ù‹');
    return;
  }

  // Embed signature image into iqrar
  let signImg = signCanvas.toDataURL('image/png');
  const signArea = document.getElementById('sign-area');
  signArea.innerHTML = `<img src="${signImg}" style="width:100%;height:100%;object-fit:contain;padding:6px;">`;
  signArea.classList.add('signed');

  // Ø­ÙØ¸ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ ÙÙŠ Supabase
  const sIqrar = currentStudent;
  const btnSign = document.querySelector('.btn-sign');
  btnSign.textContent = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
  btnSign.disabled = true;
  btnSign.style.opacity = '0.7';

  await sbSaveSignature(sIqrar.pin, sIqrar.name, sIqrar.grade, signImg);

  document.getElementById('signed-badge').style.display = 'flex';
  btnSign.textContent = 'âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¥Ù‚Ø±Ø§Ø± ÙˆØ­ÙØ¸ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹';

  // Show PDF save button
  document.getElementById('btn-save-pdf').style.display = 'inline-flex';
}

function saveIqrarPDF() {
  const sPDF = currentStudent;
  let signImgPDF = document.querySelector('#sign-area img');
  const signSrc = signImgPDF ? signImg.src : '';
  let todayPDF = new Date().toLocaleDateString('ar-SA-u-nu-latn', {year:'numeric',month:'long',day:'numeric'});

  const win = window.open('', '_blank');
  win.document.write(`
    <!DOCTYPE html>
    <html lang="ar" dir="rtl">
    <head>
      <meta charset="UTF-8">
      <title>Ø¥Ù‚Ø±Ø§Ø± ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± â€” ${sPDF.name}</title>
      <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap');
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:'Cairo',sans-serif; background:#fff; color:#1a1a2e; padding:40px; direction:rtl; }
        .header { text-align:center; margin-bottom:30px; border-bottom:3px solid #1a3a5c; padding-bottom:20px; }
        .header h1 { font-size:1.4rem; font-weight:800; color:#1a3a5c; margin-bottom:4px; }
        .header p { font-size:0.85rem; color:#5a6478; }
        .badge { display:inline-block; background:#1a3a5c; color:#fff; padding:4px 16px; border-radius:20px; font-size:0.78rem; font-weight:700; margin-bottom:10px; }
        .iqrar-text { background:#fffbf0; border:1px solid #f0d898; border-right:4px solid #c8973a; border-radius:10px; padding:18px 20px; margin:20px 0; font-size:0.9rem; line-height:2; }
        .fields { display:grid; grid-template-columns:1fr 1fr; gap:12px; margin:20px 0; }
        .field { border:1px solid #e0d8c8; border-radius:8px; padding:10px 14px; }
        .field-label { font-size:0.72rem; font-weight:700; color:#5a6478; margin-bottom:4px; }
        .field-value { font-size:0.9rem; font-weight:800; color:#1a3a5c; }
        .sign-section { margin-top:24px; }
        .sign-title { font-size:0.85rem; font-weight:700; color:#1a3a5c; margin-bottom:10px; }
        .sign-box { border:2px solid #1a3a5c; border-radius:10px; height:120px; display:flex; align-items:center; justify-content:center; overflow:hidden; }
        .sign-box img { max-height:110px; }
        .footer { margin-top:30px; text-align:center; font-size:0.75rem; color:#9ca3af; border-top:1px solid #e0d8c8; padding-top:14px; }
        @media print { body { padding:20px; } }
      </style>
    </head>
    <body>
      <div class="header">
        <div class="badge">ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ… â€” Ù…Ø¯Ø±Ø³Ø© Ù…ÙƒØ© Ø§Ù„Ù…ÙƒØ±Ù…Ø© Ø§Ù„Ù…ØªÙˆØ³Ø·Ø©</div>
        <h1>Ø¥Ù‚Ø±Ø§Ø± Ø§Ø·Ù„Ø§Ø¹ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø·Ø© Ø§Ù„ÙØ±Ø¯ÙŠØ©</h1>
        <p>Ù‚Ø³Ù… Ø°ÙˆÙŠ Ø§Ù„Ø¥Ø¹Ø§Ù‚Ø© â€” Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„Ø¯Ù…Ø¬ Ø§Ù„ÙÙƒØ±ÙŠ</p>
      </div>

      <div class="iqrar-text">
        Ø£Ù†Ø§ ÙˆÙ„ÙŠ Ø£Ù…Ø± Ø§Ù„Ø·Ø§Ù„Ø¨ / <strong>${sPDF.name}</strong>ØŒ Ø£ÙÙ‚Ø±Ù‘ Ø¨Ø£Ù†Ù†ÙŠ Ø§Ø·Ù„Ø¹ØªÙ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø·Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ© Ø§Ù„ÙØ±Ø¯ÙŠØ© Ø§Ù„Ù…ÙØ¹Ø¯ÙÙ‘Ø© Ù„Ø§Ø¨Ù†ÙŠ
        Ù„Ù„ÙØµÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ Ø§Ù„Ø«Ø§Ù†ÙŠ Ù…Ù† Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ 1447Ù‡Ù€ØŒ ÙˆØ£Ù†Ù†ÙŠ Ø¹Ù„Ù‰ Ø¯Ø±Ø§ÙŠØ© Ø¨Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‡Ø¯Ø§Ù ÙˆØ§Ù„Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„Ù…Ø°ÙƒÙˆØ±Ø© ÙÙŠÙ‡Ø§ØŒ
        ÙˆØ£ØªØ¹Ù‡Ø¯ Ø¨Ø§Ù„ØªØ¹Ø§ÙˆÙ† Ù…Ø¹ ÙØ±ÙŠÙ‚ Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„Ø¯Ù…Ø¬ Ø§Ù„ÙÙƒØ±ÙŠ Ù„ØªØ­Ù‚ÙŠÙ‚ Ø£ÙØ¶Ù„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù„Ø§Ø¨Ù†ÙŠ.
      </div>

      <div class="fields">
        <div class="field"><div class="field-label">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</div><div class="field-value">${sPDF.name}</div></div>
        <div class="field"><div class="field-label">Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ</div><div class="field-value">${sPDF.grade}</div></div>
        <div class="field"><div class="field-label">Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬</div><div class="field-value">ğŸ“˜ Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„Ø¯Ù…Ø¬ Ø§Ù„ÙÙƒØ±ÙŠ</div></div>
        <div class="field"><div class="field-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù‚Ø±Ø§Ø±</div><div class="field-value">${todayPDF}</div></div>
      </div>

      <div class="sign-section">
        <div class="sign-title">âœï¸ ØªÙˆÙ‚ÙŠØ¹ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</div>
        <div class="sign-box">
          ${signSrc ? `<img src="${signSrc}">` : '<span style="color:#9ca3af;font-size:0.85rem;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙˆÙ‚ÙŠØ¹</span>'}
        </div>
      </div>

      <div class="footer">
        Â© 1447Ù‡Ù€ â€” Ù…Ø¯Ø±Ø³Ø© Ù…ÙƒØ© Ø§Ù„Ù…ÙƒØ±Ù…Ø© Ø§Ù„Ù…ØªÙˆØ³Ø·Ø© â€” Ù‚Ø³Ù… Ø°ÙˆÙŠ Ø§Ù„Ø¥Ø¹Ø§Ù‚Ø© â€” Ø¥Ø¹Ø¯Ø§Ø¯: Ø£. Ø³Ø¹Ø¯ Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ
      </div>
      <script>window.onload=()=>window.print();<\/script>
    </body>
    </html>
  `);
  win.document.close();
}



// =====================================================
// ADMIN PANEL FUNCTIONS
// =====================================================
let editingPin = null;

function checkPin() {
  const enteredPin = document.getElementById('pin-input').value.trim();
  const errMsg = document.getElementById('error-msg');
  const pinInput = document.getElementById('pin-input');
  if (enteredPin === ADMIN_PIN) {
    errMsg.classList.remove('show'); pinInput.classList.remove('error');
    loadAdminPanel();
  } else if (STUDENTS[enteredPin]) {
    errMsg.classList.remove('show'); pinInput.classList.remove('error');
    loadStudentWithSync(enteredPin);
  } else {
    errMsg.classList.add('show'); pinInput.classList.add('error');
    pinInput.value = '';
    setTimeout(() => pinInput.classList.remove('error'), 500);
  }
}

async function loadAdminPanel() {
  document.getElementById('login-screen').style.display = 'none';
  document.getElementById('student-portal').style.display = 'none';
  document.getElementById('admin-portal').style.display = 'block';
  document.getElementById('admin-student-count').textContent = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...';
  window.scrollTo(0, 0);
  await syncFromSupabase();
  renderStudentCards();
}

// ===== SUPABASE SYNC =====
const SB_TABLE = SUPABASE_URL + '/rest/v1/dumaj_students';
const SB_HEADERS = {
  'apikey': SUPABASE_KEY,
  'Authorization': 'Bearer ' + SUPABASE_KEY,
  'Content-Type': 'application/json',
  'Prefer': 'return=minimal'
};

async function syncFromSupabase() {
  try {
    let res = await fetch(SB_TABLE + '?select=*', {
      headers: { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY }
    });
    if (!res.ok) throw new Error('fetch failed');
    let rows = await res.json();
    if (rows.length > 0) {
      rows.forEach(row => {
        if (STUDENTS[row.pin]) {
          STUDENTS[row.pin].name     = row.name;
          STUDENTS[row.pin].grade    = row.grade;
          STUDENTS[row.pin].id_full  = row.id_full;
          STUDENTS[row.pin].phone    = row.phone || '';
          STUDENTS[row.pin].plan     = row.plan     || STUDENTS[row.pin].plan || [];
          STUDENTS[row.pin].followup = row.followup || STUDENTS[row.pin].followup || [];
        } else {
          STUDENTS[row.pin] = {
            name: row.name, id_full: row.id_full, grade: row.grade,
            phone: row.phone || '', plan: row.plan||[], reports: [], followup: row.followup||[]
          };
        }
      });
    }
    console.log('âœ… Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ù…Ø¬ Ù…Ø­Ù…Ù‘Ù„Ø© Ù…Ù† Supabase');
  } catch(e) {
    console.warn('âš ï¸ ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Supabase:', e);
  }
}

async function loadStudentWithSync(pin) {
  try {
    let res = await fetch(SB_TABLE + '?pin=eq.' + pin + '&select=*', {
      headers: { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY }
    });
    if (res.ok) {
      let rows = await res.json();
      if (rows.length > 0) {
        const row = rows[0];
        if (STUDENTS[pin]) {
          STUDENTS[pin].name     = row.name;
          STUDENTS[pin].grade    = row.grade;
          STUDENTS[pin].id_full  = row.id_full;
          STUDENTS[pin].phone    = row.phone || '';
          STUDENTS[pin].plan     = row.plan     || STUDENTS[pin].plan || [];
          STUDENTS[pin].followup = row.followup || STUDENTS[pin].followup || [];
        }
      }
    }
  } catch(e) { console.warn('sync error:', e); }
  loadStudent(pin);
}

async function upsertToSupabase(pin, studentData) {
  try {
    // Ø§Ù„Ø®Ø·ÙˆØ© 1: ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯
    const patchRes = await fetch(SB_TABLE + '?pin=eq.' + encodeURIComponent(pin), {
      method: 'PATCH',
      headers: {
        'apikey': SUPABASE_KEY,
        'Authorization': 'Bearer ' + SUPABASE_KEY,
        'Content-Type': 'application/json',
        'Prefer': 'return=representation'
      },
      body: JSON.stringify({
        name:     studentData.name,
        id_full:  studentData.id_full,
        grade:    studentData.grade,
        phone:    studentData.phone || '',
        plan:     studentData.plan     || [],
        followup: studentData.followup || []
      })
    });

    const patchData = await patchRes.json();
    console.log('PATCH status:', patchRes.status, 'data:', patchData);

    // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙØ­Ø¯ÙÙ‘Ø« Ø£ÙŠ Ø³Ø¬Ù„ â€” Ø£Ø¶ÙÙ‡ ÙƒØ¬Ø¯ÙŠØ¯
    if (!Array.isArray(patchData) || patchData.length === 0) {
      const postRes = await fetch(SB_TABLE, {
        method: 'POST',
        headers: {
          'apikey': SUPABASE_KEY,
          'Authorization': 'Bearer ' + SUPABASE_KEY,
          'Content-Type': 'application/json',
          'Prefer': 'return=minimal'
        },
        body: JSON.stringify({
          pin,
          name:     studentData.name,
          id_full:  studentData.id_full,
          grade:    studentData.grade,
          phone:    studentData.phone || '',
          plan:     studentData.plan     || [],
          followup: studentData.followup || []
        })
      });
      console.log('POST status:', postRes.status);
      if (!postRes.ok) {
        const e = await postRes.text();
        showToast('âŒ ' + e.slice(0, 80));
      } else {
        showToast('âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø³Ø­Ø§Ø¨Ø©');
      }
    } else {
      showToast('âœ… ØªÙ… Ø­ÙØ¸ ' + studentData.name + ' ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©');
    }
  } catch(e) {
    console.error('Ø®Ø·Ø£:', e);
    showToast('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
  }
}

async function deleteFromSupabase(pin) {
  try {
    await fetch(SB_TABLE + '?pin=eq.' + pin, {
      method: 'DELETE',
      headers: { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY }
    });
  } catch(e) { console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù:', e); }
}

function adminLogout() {
  document.getElementById('pin-input').value = '';
  document.getElementById('admin-portal').style.display = 'none';
  document.getElementById('login-screen').style.display = 'flex';
}

function openAdminTab(id, btn) {
  document.querySelectorAll('#admin-portal .admin-tab-pane').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('#admin-portal .admin-tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('admin-tab-' + id).classList.add('active');
  btn.classList.add('active');
}

function renderStudentCards() {
  const search = (document.getElementById('admin-search')?.value || '').toLowerCase();
  const grid = document.getElementById('students-grid');
  const entries = Object.entries(STUDENTS).filter(([pin, s]) =>
    s.name.toLowerCase().includes(search) || pin.includes(search)
  );
  entries.sort((a, b) => a[1].grade.localeCompare(b[1].grade, 'ar'));
  grid.innerHTML = entries.map(([pin, s]) => `
    <div class="stu-card" onclick="openEditModal('${pin}')">
      <div class="stu-card-avatar">ğŸ§ </div>
      <div style="flex:1;min-width:0;">
        <div class="stu-card-name">${s.name}</div>
        <div class="stu-card-meta">${s.grade}</div>
        <div style="margin-top:4px;display:flex;gap:6px;align-items:center;">
          <span class="stu-card-pin">${pin}</span>
          <span style="font-size:0.7rem;color:var(--muted);">${s.phone || 'â€”'}</span>
        </div>
      </div>
      <div style="color:var(--muted);font-size:1.1rem;">âœï¸</div>
    </div>
  `).join('');
  document.getElementById('admin-student-count').textContent = Object.keys(STUDENTS).length + ' Ø·Ø§Ù„Ø¨';
}

function openEditModal(pin) {
  editingPin = pin;
  const sModal = STUDENTS[pin];
  document.getElementById('modal-title').textContent = 'âœï¸ ØªØ¹Ø¯ÙŠÙ„: ' + sModal.name;
  document.getElementById('edit-name').value = sModal.name;
  document.getElementById('edit-grade').value = sModal.grade;
  document.getElementById('edit-id').value = sModal.id_full;
  document.getElementById('edit-phone').value = sModal.phone || '';
  renderPlanEditor(sModal.plan || []);
  renderFollowupEditor(sModal.followup || []);
  openEditTab('basic', document.querySelector('#edit-modal .admin-tab-btn'));
  document.getElementById('edit-modal').classList.add('open');
}

function openEditTab(id, btn) {
  ['basic','plan','followup'].forEach(t => {
    document.getElementById('edit-tab-' + t).style.display = t === id ? 'block' : 'none';
  });
  document.querySelectorAll('#edit-modal .admin-tab-btn').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');
}

function closeModal() {
  document.getElementById('edit-modal').classList.remove('open');
  editingPin = null;
}

function renderPlanEditor(plan) {
  let container = document.getElementById('plan-goals-editor');
  container.innerHTML = plan.map((g, i) => goalRowHTML(g.title, g.desc, i)).join('');
}

function goalRowHTML(title, desc, i) {
  return `<div class="goal-row" id="goal-row-${i}">
    <button class="btn-remove-goal" onclick="removeGoalRow(${i})">âœ•</button>
    <input type="text" class="form-input" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù‡Ø¯Ù" value="${title||''}" data-goal-title="${i}">
    <input type="text" class="form-input" placeholder="ÙˆØµÙ Ø§Ù„Ù‡Ø¯Ù" value="${desc||''}" data-goal-desc="${i}">
  </div>`;
}

function addGoalRow() {
  let container = document.getElementById('plan-goals-editor');
  let i = container.children.length;
  let div = document.createElement('div');
  div.innerHTML = goalRowHTML('', '', i);
  container.appendChild(div.firstChild);
}

function removeGoalRow(i) { document.getElementById('goal-row-' + i)?.remove(); }

const FU_OPTIONS = ['âœ“','~','âœ—'];

function renderFollowupEditor(followup) {
  document.getElementById('followup-editor').innerHTML = followup.map((f, i) => followupRowHTML(f, i)).join('');
}

function followupRowHTML(f, i) {
  const sel = (val, key) => FU_OPTIONS.map(o => `<option value="${o}" ${f[key]===o?'selected':''}>${o}</option>`).join('');
  return `<div class="fu-edit-row" id="fu-row-${i}">
    <input type="text" placeholder="Ø§Ù„Ù…Ù‡Ø§Ø±Ø©" value="${f.skill||''}" data-fu-skill="${i}">
    <select data-fu-m1="${i}">${sel(f.m1,'m1')}</select>
    <select data-fu-m2="${i}">${sel(f.m2,'m2')}</select>
    <select data-fu-m3="${i}">${sel(f.m3,'m3')}</select>
    <select data-fu-m4="${i}">${sel(f.m4,'m4')}</select>
    <select data-fu-m5="${i}">${sel(f.m5,'m5')}</select>
    <button onclick="removeFuRow(${i})" style="background:#fee2e2;color:#dc2626;border:none;border-radius:6px;width:26px;height:26px;cursor:pointer;font-size:0.8rem;">âœ•</button>
  </div>`;
}

function addFollowupRow() {
  let container = document.getElementById('followup-editor');
  let i = container.children.length;
  let div = document.createElement('div');
  div.innerHTML = followupRowHTML({skill:'',m1:'~',m2:'~',m3:'~',m4:'~',m5:'~'}, i);
  container.appendChild(div.firstChild);
}

function removeFuRow(i) { document.getElementById('fu-row-' + i)?.remove(); }

function saveStudentEdits() {
  if (!editingPin) return;
  const sEdit = STUDENTS[editingPin];
  sEdit.name    = document.getElementById('edit-name').value.trim() || sEdit.name;
  sEdit.grade   = document.getElementById('edit-grade').value.trim() || sEdit.grade;
  sEdit.id_full = document.getElementById('edit-id').value.trim() || sEdit.id_full;
  sEdit.phone   = document.getElementById('edit-phone').value.trim();
  const goalTitles = document.querySelectorAll('[data-goal-title]');
  const goalDescs  = document.querySelectorAll('[data-goal-desc]');
  sEdit.plan = [];
  goalTitles.forEach((el, i) => {
    const title = el.value.trim();
    const desc  = goalDescs[i]?.value.trim() || '';
    if (title) sEdit.plan.push({ title, desc, color: '#c25a00' });
  });
  const fuSkills = document.querySelectorAll('[data-fu-skill]');
  sEdit.followup = [];
  fuSkills.forEach((el, i) => {
    const skill = el.value.trim();
    if (skill) sEdit.followup.push({
      skill,
      m1: document.querySelector(`[data-fu-m1="${i}"]`)?.value || '~',
      m2: document.querySelector(`[data-fu-m2="${i}"]`)?.value || '~',
      m3: document.querySelector(`[data-fu-m3="${i}"]`)?.value || '~',
      m4: document.querySelector(`[data-fu-m4="${i}"]`)?.value || '~',
      m5: document.querySelector(`[data-fu-m5="${i}"]`)?.value || '~',
    });
  });
  closeModal();
  renderStudentCards();
  showToast('â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...');
  upsertToSupabase(editingPin, sEdit).then(() => showToast('âœ… ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª ' + sEdit.name));
}

function deleteStudent() {
  if (!editingPin) return;
  const sDel = STUDENTS[editingPin];
  if (!confirm(`âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨ "${sDel.name}"?`)) return;
  const deletedPin = editingPin;
  delete STUDENTS[deletedPin];
  closeModal();
  renderStudentCards();
  deleteFromSupabase(deletedPin).then(() => showToast('ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨ ' + sDel.name));
}

document.addEventListener('input', e => {
  if (e.target.id === 'new-id') {
    const val = e.target.value.trim();
    document.getElementById('new-pin-preview').value = val.length >= 4 ? val.slice(-4) : '';
  }
});

function addNewStudent() {
  const newName  = document.getElementById('new-name').value.trim();
  const newId    = document.getElementById('new-id').value.trim();
  const newGrade = document.getElementById('new-grade').value.trim();
  const newPhone = document.getElementById('new-phone').value.trim();
  if (!newName || !newId || !newGrade) { alert('âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø³Ø¬Ù„ ÙˆØ§Ù„ØµÙ'); return; }
  if (newId.length < 4) { alert('âš ï¸ Ø±Ù‚Ù… Ø§Ù„Ø³Ø¬Ù„ Ù‚ØµÙŠØ± Ø¬Ø¯Ø§Ù‹'); return; }
  const newPin = newId.slice(-4);
  if (STUDENTS[newPin]) { alert(`âš ï¸ Ø§Ù„Ø±Ù…Ø² "${newPin}" Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„Ø·Ø§Ù„Ø¨: ${STUDENTS[newPin].name}`); return; }
  STUDENTS[newPin] = { name: newName, id_full: newId, grade: newGrade, phone: newPhone, plan: [], reports: [], followup: [] };
  ['new-name','new-id','new-grade','new-phone','new-pin-preview'].forEach(fieldId => {
    const fieldEl = document.getElementById(fieldId); if (fieldEl) fieldEl.value = '';
  });
  openAdminTab('list', document.querySelector('.admin-tab-btn'));
  renderStudentCards();
  showToast('â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...');
  upsertToSupabase(newPin, STUDENTS[newPin]).then(() =>
    showToast('âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø§Ù„Ø¨ ' + newName + ' â€” Ø§Ù„Ø±Ù…Ø²: ' + newPin)
  );
}

function showToast(msg) {
  const t = document.getElementById('success-toast');
  t.textContent = msg; t.style.display = 'block';
  setTimeout(() => t.style.display = 'none', 3000);
}

document.getElementById('edit-modal')?.addEventListener('click', e => {
  if (e.target === document.getElementById('edit-modal')) closeModal();
});
</script>
</body>
</html>
